<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <link rel="icon" type="image/x-icon" href="/favicon.ico">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ח.סבן חומרי בניין - צ'אט מונפש</title>
  <style>
    :root {
      --primary-color: #075e54;
      --secondary-color: #128c7e;
      --bg-color: #e5ddd5;
      --message-bg: #dcf8c6;
      --bot-message-bg: #ffffff;
      --error-color: #ff4d4d;
      --keyword-bg: linear-gradient(45deg, #25d366, #128c7e);
      --fallback-bg: url('https://via.placeholder.com/380x760?text=WhatsApp+Background');
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      background: linear-gradient(135deg, #f0f4f8, #d9e2ec);
      font-family: 'Rubik', sans-serif;
      overflow-x: hidden;
    }

    #phoneFrame {
      width: 380px;
      height: 760px;
      background: url('https://i.postimg.cc/t4Q91FDQ/Screenshot-20250427-160448-Whats-App-Business.jpg') no-repeat center/cover, var(--fallback-bg);
      border: 10px solid #000;
      border-radius: 40px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
      position: relative;
      overflow: hidden;
      transition: all 0.3s ease;
    }

    #phoneFrame.fullscreen {
      width: 100vw;
      height: 100vh;
      border: none;
      border-radius: 0;
    }

    #chatContainer {
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      background: transparent;
    }

    #chatHeader {
      background: var(--primary-color);
      color: white;
      padding: 10px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
    }

    #chatHeader img {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      margin-left: 10px;
    }

    #chatHeader h1 {
      font-size: 18px;
      flex-grow: 1;
    }

    #chatBody {
      flex-grow: 1;
      padding: 10px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 10px;
      background: transparent;
    }

    .message {
      max-width: 80%;
      padding: 10px;
      border-radius: 10px;
      position: relative;
      font-size: 16px;
      line-height: 1.4;
      word-wrap: break-word;
    }

    .user-message {
      background: var(--message-bg);
      align-self: flex-end;
      margin-left: 10px;
      border-bottom-right-radius: 2px;
    }

    .bot-message {
      background: var(--bot-message-bg);
      align-self: flex-start;
      margin-right: 10px;
      border-bottom-left-radius: 2px;
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
    }

    .welcome-message, .name-prompt {
      font-weight: bold;
      color: var(--primary-color);
    }

    .message-time {
      font-size: 12px;
      color: #888;
      position: absolute;
      bottom: -18px;
      left: 10px;
    }

    .typing {
      display: flex;
      gap: 5px;
      align-self: flex-start;
      padding: 10px;
    }

    .typing span {
      width: 8px;
      height: 8px;
      background: var(--primary-color);
      border-radius: 50%;
      animation: typing 1.2s infinite;
    }

    .typing span:nth-child(2) { animation-delay: 0.2s; }
    .typing span:nth-child(3) { animation-delay: 0.4s; }

    @keyframes typing {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-10px); }
    }

    #keywordsContainer {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 300px;
      height: 300px;
      display: none;
    }

    #keywordsContainer.active {
      display: block;
    }

    .keyword-btn {
      position: absolute;
      padding: 10px 20px;
      background: var(--keyword-bg);
      color: white;
      border: none;
      border-radius: 20px;
      cursor: pointer;
      font-size: 14px;
      font-weight: bold;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
      transition: all 0.3s ease;
      animation: spin 10s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg) translateX(150px) rotate(0deg); }
      100% { transform: rotate(360deg) translateX(150px) rotate(-360deg); }
    }

    @keyframes throwEffect {
      0% { transform: translate(0, 0) scale(1); opacity: 1; }
      100% { transform: translate(100px, -100px) scale(0.5); opacity: 0; }
    }

    #chatFooter {
      display: flex;
      align-items: center;
      padding: 10px;
      background: var(--bg-color);
      border-top: 1px solid #ccc;
      position: relative;
    }

    #userInput {
      flex-grow: 1;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 20px;
      font-size: 16px;
      outline: none;
      transition: border-color 0.3s ease;
    }

    #userInput.guide {
      border-color: var(--secondary-color);
      box-shadow: 0 0 5px var(--secondary-color);
    }

    #sendBtn, #attachBtn, .fullscreen-btn {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      margin: 0 5px;
      color: var(--primary-color);
    }

    #attachMenu {
      display: none;
      position: absolute;
      bottom: 60px;
      left: 10px;
      background: white;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
      padding: 10px;
      z-index: 10;
    }

    #attachMenu button {
      display: block;
      background: none;
      border: none;
      padding: 10px;
      font-size: 16px;
      color: var(--primary-color);
      cursor: pointer;
      width: 100%;
      text-align: right;
    }

    #stylus {
      position: absolute;
      bottom: 20px;
      left: 30px;
      width: 24px;
      height: 24px;
      background: url('https://i.postimg.cc/3J9Y4b0Z/blocks.jpg') no-repeat center/cover;
      transition: transform 0.2s ease;
      pointer-events: none;
    }

    #stylus.typing {
      transform: translateX(10px) rotate(10deg);
    }

    #virtualKeyboard {
      display: none;
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: #f0f0f0;
      padding: 10px;
      flex-wrap: wrap;
      gap: 5px;
      justify-content: center;
    }

    #virtualKeyboard button {
      padding: 10px;
      font-size: 18px;
      border: 1px solid #ccc;
      border-radius: 5px;
      background: white;
      cursor: pointer;
    }

    #orderPopup, #howToPopup {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
      z-index: 100;
      max-width: 90%;
      max-height: 80vh;
      overflow-y: auto;
    }

    #overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 99;
    }

    #orderForm, #howToContent {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    #orderForm input, #orderForm select {
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 5px;
      font-size: 16px;
    }

    .item-row {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .item-name, .item-quantity, .item-price {
      flex: 1;
      padding: 5px;
    }

    .item-price {
      background: #f0f0f0;
    }

    .remove-item {
      background: var(--error-color);
      color: white;
      border: none;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      cursor: pointer;
    }

    #containerCost {
      display: none;
      color: var(--error-color);
      font-size: 14px;
    }

    .error-message {
      color: var(--error-color);
      text-align: center;
      font-weight: bold;
      margin: 20px;
    }

    @media (max-width: 400px) {
      #phoneFrame {
        width: 100%;
        height: 100vh;
        border: none;
        border-radius: 0;
      }
    }
  </style>
</head>
<body>
  <div id="phoneFrame">
    <div id="chatContainer">
      <div id="chatHeader">
        <img src="https://i.postimg.cc/3J9Y4b0Z/blocks.jpg" alt="בלוקים">
        <h1>ח.סבן חומרי בניין</h1>
        <button class="fullscreen-btn" onclick="toggleFullscreen()">🔲</button>
      </div>
      <div id="chatBody"></div>
      <div id="keywordsContainer"></div>
      <div id="chatFooter">
        <button id="attachBtn" onclick="toggleAttachMenu()">📎</button>
        <div id="attachMenu">
          <button onclick="document.getElementById('fileInput').click()">📄 העלאת קובץ</button>
          <button onclick="shareLocation()">📍 שיתוף מיקום</button>
          <button onclick="addToCalendar()">📅 הוסף ללוח שנה</button>
          <button onclick="showKeyboard()">⌨️ מקלדת וירטואלית</button>
        </div>
        <input type="file" id="fileInput" style="display: none;" onchange="uploadFile()">
        <div id="stylus"></div>
        <input type="text" id="userInput" placeholder="הקלד הודעה..." oninput="moveStylus()" onkeypress="if(event.key === 'Enter') sendMessage()">
        <button id="sendBtn" onclick="sendMessage()">➤</button>
      </div>
    </div>
  </div>
  <div id="virtualKeyboard">
    <button onclick="typeKey('א')">א</button>
    <button onclick="typeKey('ב')">ב</button>
    <button onclick="typeKey('ג')">ג</button>
    <button onclick="typeKey('ד')">ד</button>
    <button onclick="typeKey('ה')">ה</button>
    <button onclick="typeKey('ו')">ו</button>
    <button onclick="typeKey('ז')">ז</button>
    <button onclick="typeKey('ח')">ח</button>
    <button onclick="typeKey('ט')">ט</button>
    <button onclick="typeKey('י')">י</button>
    <button onclick="typeKey('כ')">כ</button>
    <button onclick="typeKey('ל')">ל</button>
    <button onclick="typeKey('מ')">מ</button>
    <button onclick="typeKey('נ')">נ</button>
    <button onclick="typeKey('ס')">ס</button>
    <button onclick="typeKey('ע')">ע</button>
    <button onclick="typeKey('פ')">פ</button>
    <button onclick="typeKey('צ')">צ</button>
    <button onclick="typeKey('ק')">ק</button>
    <button onclick="typeKey('ר')">ר</button>
    <button onclick="typeKey('ש')">ש</button>
    <button onclick="typeKey('ת')">ת</button>
    <button onclick="typeKey(' ')">רווח</button>
    <button onclick="sendMessage()">שלח</button>
    <button onclick="closeKeyboard()">סגור</button>
  </div>
  <div id="orderPopup">
    <h2>טופס הזמנה</h2>
    <div id="orderForm">
      <input type="text" id="orderCustomer" placeholder="שם הלקוח">
      <input type="text" id="orderContact" placeholder="איש קשר">
      <input type="tel" id="orderPhone" placeholder="מספר טלפון">
      <select id="orderCrane">
        <option value="ללא">ללא מנוף</option>
        <option value="מנוף">עם מנוף</option>
      </select>
      <input type="text" id="orderStreet" placeholder="רחוב">
      <input type="text" id="orderCity" placeholder="עיר">
      <select id="orderContainer" onchange="showContainerCost()">
        <option value="ללא">ללא מכולה</option>
        <option value="6 קוב">מכולה 6 קוב</option>
        <option value="12 קוב">מכולה 12 קוב</option>
      </select>
      <p id="containerCost">עלות מכולה: 1500 ש"ח (לא כולל מע"מ)</p>
      <table>
        <thead>
          <tr>
            <th>שם המוצר</th>
            <th>כמות</th>
            <th>מחיר</th>
            <th></th>
          </tr>
        </thead>
        <tbody id="itemsTableBody">
          <tr class="item-row">
            <td><select class="item-name" onchange="updateItemPrice(this)"></select></td>
            <td><input type="number" class="item-quantity" min="1" placeholder="כמות"></td>
            <td><input type="text" class="item-price" readonly></td>
            <td><button class="remove-item" onclick="removeItemRow(this)">×</button></td>
          </tr>
        </tbody>
      </table>
      <button onclick="addItemRow()">+ הוסף פריט</button>
      <button onclick="submitOrder()">שלח הזמנה</button>
      <button onclick="closeOrderPopup()">בטל</button>
    </div>
  </div>
  <div id="howToPopup">
    <h2>איך אני עובד?</h2>
    <div id="howToContent">
      <p>שלום! אני ראמי, הבוט של ח.סבן חומרי בניין! 😎</p>
      <p>אני כאן כדי לעזור לך עם מידע על מוצרים, הזמנות, או סתם לשוחח על המחסן!</p>
      <p>איך להשתמש בי:</p>
      <ul>
        <li>הקלד את שמך כדי להתחיל.</li>
        <li>לחץ על מילות מפתח מסתובבות או הקלד שאלות כמו "בלוקים" או "צבעים".</li>
        <li>פתח טופס הזמנה כדי לשלוח הזמנה ישירות למחסן.</li>
        <li>שלח קבצים, שתף מיקום, או הוסף אירועים ללוח השנה!</li>
      </ul>
      <button onclick="closeHowToPopup()">סגור</button>
    </div>
  </div>
  <div id="overlay"></div>

  <script>
    let userName = '';
    let userPhone = '';
    let conversation = [];
    let responses = [];
    let products = [];
    let keywords = [];
    let namePrompted = false;

    const API_KEY = 'AIzaSyCNn7GZMsQPCdRSfgz_o08M1YV63CkA3Ow'; // החלף במפתח API של Google Sheets
    const SCRIPT_URL = 'YOUR_NEW_SCRIPT_URL'; // החלף ב-URL של ה-Web App

    const fallbackKeywords = [
      { label: 'בלוקים', question: 'מידע על בלוקים' },
      { label: 'צבעים', question: 'מידע על צבעים' },
      { label: 'כלים', question: 'מידע על כלים' },
      { label: 'הזמנה', question: 'פתח טופס הזמנה' }
    ];

    const nameData = {
      'ורד': {
        traits: 'זורחת כמו פרח, מלאת חיים ואנרגיה!',
        ramiThought: 'ורד היא כמו בלוק מושלם – יפה, חזקה, ותמיד מוסיפה צבע! 🌹',
        quip: 'ורד, עם שם כזה, את בטח שוברת לבבות במחסן! 😜'
      },
      'תמיר': {
        traits: 'מעודד, תמיד עם חיוך, מחסנאי מספר אחת!',
        ramiThought: 'תמיר הוא החבר שתמיד שם כשהמשמרת נהיית קשה! 💪',
        quip: 'תמיר, אתה מעודד את כולם, אבל מי מעודד אותך כשאשר שוב מדפיס את השבוע? 😅'
      },
      'אורן': {
        traits: 'חביב, תותח על המלגזה, קצת גמד אבל ענק בלב!',
        ramiThought: 'אורן דופק עבודה כשצריך, אבל לפעמים צריך לדחוף אותו קצת! 🚜',
        quip: 'אורן, גמדגמד, אבל כשאתה על המלגזה, אתה מלך המחסן! 😎'
      },
      'עלא': {
        traits: 'חברותי, תמיד עם סיפור טוב, מרים את המורל!',
        ramiThought: 'עלא מביא את האנרגיה, כמו משאית מלאה בלוקים! 🚚',
        quip: 'עלא, עם הסיפורים שלך, אתה צריך פודקאסט במחסן! 🎙️'
      },
      'עלי': {
        traits: 'נאמן, עובד קשה, תמיד נותן 100%!',
        ramiThought: 'עלי הוא כמו מלט – מחזיק הכל ביחד! 🧱',
        quip: 'עלי, אתה עובד כל כך קשה, אפילו המלגזה מבקשת הפסקה! 😜'
      },
      'יואב': {
        traits: 'חכם, יצירתי, תמיד עם פתרון לכל בעיה!',
        ramiThought: 'יואב הוא הראש החושב של המחסן, כמו מהנדס בלוקים! 🧠',
        quip: 'יואב, עם הראש שלך, אתה תמציא בלוק שמרכיב את עצמו! 😅'
      },
      'נתנאל': {
        traits: 'רגוע, אמין, תמיד שומר על קור רוח!',
        ramiThought: 'נתנאל הוא כמו מים ביום חם – מרגיע את כולם! 💧',
        quip: 'נתנאל, אתה כל כך רגוע, אפילו אשר לא מצליח להוציא אותך מהקצב! 😎'
      },
      'דורון': {
        traits: 'נדיב, תמיד עוזר, לב זהב!',
        ramiThought: 'דורון הוא כמו משאית שמביאה את כל הטוב למחסן! 🚛',
        quip: 'דורון, עם הלב שלך, אתה יכול למכור בלוקים בחינם ועדיין להרוויח! 😜'
      },
      'לינה': {
        traits: 'אהובת לבו של ראמי, מקסימה ומלאת קסם!',
        ramiThought: 'לינה היא הלב של המחסן, כל יום איתה הוא כמו חג! 💖',
        quip: 'לינה, ראמי אומר שאת הבלוק הכי יפה במחסן! 😍'
      },
      'שרון': {
        traits: 'צרפתיה מרעננה, תמיד עם סטייל וחיוך!',
        ramiThought: 'שרון מביאה קלאסה למחסן, כמו צבע פרימיום! 🎨',
        quip: 'שרון, עם הסטייל שלך, את יכולה למכור בלוקים בתצוגת אופנה! 😅'
      },
      'אשר': {
        traits: 'משגע את כולם עם הדפסות השבוע, אבל תמיד מצחיק!',
        ramiThought: 'אשר הוא כמו משאית שלא קוראת את המסלול, אבל בסוף מגיע! 📄',
        quip: 'אשר, תפסיק להדפיס את השבוע, ראמי כבר לא יכול לראות נייר! 😜'
      }
    };

    function preloadImages() {
      const images = [
        { src: 'https://i.postimg.cc/t4Q91FDQ/Screenshot-20250427-160448-Whats-App-Business.jpg', fallback: 'https://via.placeholder.com/380x760?text=WhatsApp+Background' },
        { src: 'https://i.postimg.cc/3J9Y4b0Z/blocks.jpg', fallback: 'https://via.placeholder.com/24?text=Stylus' },
        { src: 'https://i.postimg.cc/5y3t8QzT/paint.jpg', fallback: 'https://via.placeholder.com/220?text=Paint' },
        { src: 'https://i.postimg.cc/4yqP2R9Z/tools.jpg', fallback: 'https://via.placeholder.com/220?text=Tools' }
      ];
      images.forEach(image => {
        const img = new Image();
        img.src = image.src;
        img.onerror = () => { img.src = image.fallback; };
      });
    }

    async function fetchResponses() {
      try {
        const sheetId = '13fP3cH_npVSYz-cHZWL27-cGwHldBP3VdnBdFZq4wN0';
        const response = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${sheetId}/values/Sheet1!A1:D1000?key=${API_KEY}`);
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        const data = await response.json();
        if (!data.values || data.values.length < 2) throw new Error('No responses found');
        responses = data.values.slice(1).map(row => ({
          question: row[0] || '',
          answer: row[1] || '',
          keywords: row[2] ? row[2].split(',').map(k => k.trim()) : [],
          synonyms: row[3] ? row[3].split(',').map(s => s.trim()) : []
        }));
        keywords = responses.map(r => ({ label: r.question, question: r.question }));
        updateKeywords();
      } catch (err) {
        console.error('Error fetching responses:', err);
        responses = [];
        keywords = fallbackKeywords;
        updateKeywords();
        displayBotMessage('אופס, לא הצלחתי לטעון את התשובות... 😅 אבל אל דאגה, אני עדיין כאן! נסה לשאול על "בלוקים" או "צבעים".');
      }
    }

    async function fetchProducts() {
      try {
        const sheetId = '1T14O3eVJzJqBXe6pr5flLckvpM4TGRycTYp5Elq2KSY';
        const response = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${sheetId}/values/Sheet1!A1:E1000?key=${API_KEY}`);
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        const data = await response.json();
        if (!data.values || data.values.length < 2) throw new Error('No products found');
        products = data.values.slice(1).map(row => ({
          name: row[0] || '',
          category: row[1] || '',
          price: parseFloat(row[2]) || 0,
          stock: parseInt(row[3]) || 0,
          description: row[4] || ''
        }));
        updateProductSelects();
      } catch (err) {
        console.error('Error fetching products:', err);
        products = [];
        displayBotMessage('אופס, לא הצלחתי לטעון את המוצרים... 😅 אבל תוכל להזמין דרך הטופס!');
      }
    }

    function updateProductSelects() {
      const selects = document.querySelectorAll('.item-name');
      if (!selects.length) return;
      selects.forEach(select => {
        select.innerHTML = '<option value="">בחר מוצר</option>' + products.map(product => 
          `<option value="${product.name}" data-price="${product.price}" data-stock="${product.stock}">${product.name} (${product.stock} במלאי)</option>`
        ).join('');
      });
    }

    function updateItemPrice(select) {
      const row = select.closest('.item-row');
      if (!row) return;
      const priceInput = row.querySelector('.item-price');
      const selectedOption = select.options[select.selectedIndex];
      const price = selectedOption ? selectedOption.getAttribute('data-price') : '';
      priceInput.value = price ? `${price} ש"ח` : '';
    }

    async function saveUser(name, phone) {
      try {
        const response = await fetch(SCRIPT_URL, {
          method: 'POST',
          body: JSON.stringify({ action: 'saveUser', data: { name, phone } })
        });
        const result = await response.json();
        if (result.status !== 'הצלחה') throw new Error(result.message);
      } catch (err) {
        console.error('Error saving user:', err);
        displayBotMessage('לא הצלחתי לשמור את המשתמש, אבל נמשיך הלאה! 😎');
      }
    }

    async function saveChat(userName, question, answer) {
      try {
        const response = await fetch(SCRIPT_URL, {
          method: 'POST',
          body: JSON.stringify({ action: 'saveChat', data: { userName, question, answer } })
        });
        const result = await response.json();
        if (result.status !== 'הצלחה') throw new Error(result.message);
      } catch (err) {
        console.error('Error saving chat:', err);
      }
    }

    async function updateStats(messageCount, orderCount) {
      try {
        const response = await fetch(SCRIPT_URL, {
          method: 'POST',
          body: JSON.stringify({ action: 'updateStats', data: { messageCount, orderCount } })
        });
        const result = await response.json();
        if (result.status !== 'הצלחה') throw new Error(result.message);
      } catch (err) {
        console.error('Error updating stats:', err);
      }
    }

    async function addToResponses(question, answer, keywords = [], synonyms = []) {
      try {
        const response = await fetch(SCRIPT_URL, {
          method: 'POST',
          body: JSON.stringify({
            action: 'addResponse',
            data: { question, answer, keywords: keywords.join(','), synonyms: synonyms.join(',') }
          })
        });
        const result = await response.json();
        if (result.status !== 'הצלחה') throw new Error(result.message);
        responses.push({ question, answer, keywords, synonyms });
        keywords.push({ label: question, question });
        updateKeywords();
      } catch (err) {
        console.error('Error adding to responses:', err);
      }
    }

    async function sendMessage(inputText = null) {
      const chatBody = document.getElementById('chatBody');
      if (!chatBody) {
        console.error('chatBody not found');
        return;
      }

      const userInput = document.getElementById('userInput');
      if (!userInput) {
        console.error('userInput not found');
        return;
      }

      const message = inputText || userInput.value.trim();
      if (!message) return;

      displayUserMessage(message);
      userInput.value = '';
      moveStylus();

      if (!userName) {
        userName = message;
        await saveUser(userName, userPhone);
        displayBotMessage(`נעים להכיר, ${userName}! 😎 אני ראמי, הבוט של ח.סבן חומרי בניין!`);
        if (nameData[userName]) {
          const nameInfo = nameData[userName];
          displayBotMessage(`<span class="name-prompt">תרצה שאגלה לך מה אומר השם שלך עד שראמי יענה? 😎</span>`);
          namePrompted = true;
        } else {
          displayBotMessage('איך אפשר לעזור לך היום? 🏗️');
          updateKeywords();
        }
        return;
      }

      if (namePrompted && (message.toLowerCase().includes('כן') || message.toLowerCase().includes('בטח'))) {
        namePrompted = false;
        await handleNamePrediction(userName);
        return;
      }

      showTypingIndicator();
      const response = findResponse(message);
      setTimeout(async () => {
        hideTypingIndicator();
        displayBotMessage(response);
        await saveChat(userName, message, response);
        await updateStats(conversation.length, document.querySelectorAll('.item-row').length);
        if (nameData[userName] && Math.random() < 0.3) {
          displayBotMessage(nameData[userName].quip);
        }
      }, 1000);
    }

    async function handleNamePrediction(name) {
      if (name === 'ורד') {
        const motivation = [
          'ורד, את כמו פרח שפורח בכל מצב! 🌹',
          'השם שלך מביא אור לכל מחסן, תמשיכי לזרוח!',
          'ורד, הכוח שלך הוא כמו בלוק – אי אפשר לשבור אותו!'
        ];
        const encouragement = [
          'ורד, בעבודה את תמיד תזרחי כמו כוכב! 🌟',
          'הילדים שלך בטח גאים בך, ורד, את אמא מדהימה!',
          'ורד, תמשיכי לנהל את הכל כמו בוסית במחסן!'
        ];
        const prediction = `ורד, השם שלך זורח כמו פרח! 🌹 תרצי לדעת מה צפוי לך? וואו, יש כל כך הרבה להרחיב! אני חוזה שתמשיכי להפיץ אור בכל מקום, וראמי בטוח יסכים! 😎`;
        displayBotMessage(prediction);
        for (const msg of [...motivation, ...encouragement]) {
          await addToResponses(`מוטיבציה לורד`, msg, ['ורד', 'מוטיבציה'], ['חיזוי', 'עידוד']);
        }
      } else if (nameData[name]) {
        const { traits, ramiThought, quip } = nameData[name];
        displayBotMessage(`וואו, ${name}! השם שלך אומר: ${traits} 😎 ראמי חושב: "${ramiThought}"`);
        displayBotMessage(quip);
        await addToResponses(`חיזוי ל-${name}`, `${traits} | ${ramiThought} | ${quip}`, [name, 'חיזוי'], ['שם', 'ראמי']);
      } else {
        displayBotMessage(`השם ${name} ממש מגניב! 😎 אני חוזה שתהיה כוכב במחסן, וראמי בטח מסכים!`);
        await addToResponses(`חיזוי ל-${name}`, `כוכב במחסן!`, [name, 'חיזוי'], ['שם', 'ראמי']);
      }
    }

    function findResponse(message) {
      const messageLower = message.toLowerCase();
      for (const response of responses) {
        const keywords = response.keywords.map(k => k.toLowerCase());
        const synonyms = response.synonyms.map(s => s.toLowerCase());
        if (keywords.some(k => messageLower.includes(k)) || 
            synonyms.some(s => messageLower.includes(s)) ||
            messageLower.includes(response.question.toLowerCase())) {
          return response.answer;
        }
      }
      return 'לא הבנתי את השאלה... 🤔 נסה מילות מפתח כמו "בלוקים", "צבעים", או "הזמנה"!';
    }

    function displayUserMessage(message) {
      const chatBody = document.getElementById('chatBody');
      if (!chatBody) {
        console.error('chatBody not found');
        return;
      }
      const messageDiv = document.createElement('div');
      messageDiv.className = 'message user-message';
      messageDiv.innerHTML = `${message}<span class="message-time">${getCurrentTime()}</span>`;
      chatBody.appendChild(messageDiv);
      chatBody.scrollTop = chatBody.scrollHeight;
      conversation.push({ type: 'user', text: message });
    }

    function displayBotMessage(message) {
      const chatBody = document.getElementById('chatBody');
      if (!chatBody) {
        console.error('chatBody not found');
        return;
      }
      const messageDiv = document.createElement('div');
      messageDiv.className = `message bot-message ${message.includes('תרצה שאגלה') ? 'name-prompt' : ''}`;
      messageDiv.innerHTML = `${message}<span class="message-time">${getCurrentTime()}</span>`;
      chatBody.appendChild(messageDiv);
      chatBody.scrollTop = chatBody.scrollHeight;
      conversation.push({ type: 'bot', text: message });
    }

    function showTypingIndicator() {
      const chatBody = document.getElementById('chatBody');
      if (!chatBody) return;
      const typingDiv = document.createElement('div');
      typingDiv.className = 'typing';
      typingDiv.innerHTML = '<span></span><span></span><span></span>';
      chatBody.appendChild(typingDiv);
      chatBody.scrollTop = chatBody.scrollHeight;
    }

    function hideTypingIndicator() {
      const typingDiv = document.querySelector('.typing');
      if (typingDiv) typingDiv.remove();
    }

    function getCurrentTime() {
      return new Date().toLocaleTimeString('he-IL', { hour: '2-digit', minute: '2-digit' });
    }

    function updateKeywords() {
      const keywordsContainer = document.getElementById('keywordsContainer');
      if (!keywordsContainer) {
        console.error('keywordsContainer not found');
        return;
      }
      keywordsContainer.innerHTML = '';
      const currentKeywords = userName ? keywords : [{ label: 'התחל שיחה', question: 'היי' }];
      if (!currentKeywords.length) {
        currentKeywords.push(...fallbackKeywords);
      }
      currentKeywords.forEach((keyword, index) => {
        const btn = document.createElement('button');
        btn.className = 'keyword-btn';
        btn.style.transform = `rotate(${index * (360 / currentKeywords.length)}deg) translateX(150px) rotate(-${index * (360 / currentKeywords.length)}deg)`;
        btn.style.animationDelay = `${index * 0.2}s`;
        btn.textContent = keyword.label;
        btn.onclick = () => {
          sendMessage(keyword.question);
          btn.style.animation = 'throwEffect 0.5s ease forwards';
          setTimeout(() => updateKeywords(), 500);
          displayBotMessage('וואו, הכפתור זרח כמו הבלוקים של ראמי! ✨');
        };
        keywordsContainer.appendChild(btn);
      });
    }

    function toggleFullscreen() {
      const phoneFrame = document.getElementById('phoneFrame');
      if (!phoneFrame) return;
      phoneFrame.classList.toggle('fullscreen');
      const btn = document.querySelector('.fullscreen-btn');
      if (btn) btn.textContent = phoneFrame.classList.contains('fullscreen') ? '🔳' : '🔲';
    }

    function toggleAttachMenu() {
      const menu = document.getElementById('attachMenu');
      if (!menu) return;
      menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
    }

    function showKeyboard() {
      const keyboard = document.getElementById('virtualKeyboard');
      if (!keyboard) return;
      keyboard.style.display = 'flex';
    }

    function closeKeyboard() {
      const keyboard = document.getElementById('virtualKeyboard');
      if (!keyboard) return;
      keyboard.style.display = 'none';
    }

    function typeKey(char) {
      const userInput = document.getElementById('userInput');
      if (!userInput) return;
      userInput.value += char;
      moveStylus();
    }

    function moveStylus() {
      const stylus = document.getElementById('stylus');
      const userInput = document.getElementById('userInput');
      if (!stylus || !userInput) return;
      if (userInput.value.trim()) {
        stylus.classList.add('typing');
      } else {
        stylus.classList.remove('typing');
      }
    }

    function uploadFile() {
      const fileInput = document.getElementById('fileInput');
      if (!fileInput || !fileInput.files[0]) return;
      const file = fileInput.files[0];
      const reader = new FileReader();
      reader.onload = () => {
        displayBotMessage(`קובץ "${file.name}" נשלח! 📄`);
      };
      reader.readAsDataURL(file);
    }

    function shareLocation() {
      if (!navigator.geolocation) {
        displayBotMessage('שיתוף מיקום לא נתמך בדפדפן זה... 😔');
        return;
      }
      navigator.geolocation.getCurrentPosition(
        position => {
          const { latitude, longitude } = position.coords;
          displayBotMessage(`מיקום משותף: ${latitude}, ${longitude} 📍`);
        },
        () => {
          displayBotMessage('לא הצלחתי לקבל את המיקום... 😔 ודא שהרשאות המיקום מופעלות.');
        }
      );
    }

    function addToCalendar() {
      displayBotMessage('אירוע נוסף ללוח השנה שלך! 📅');
    }

    function openOrderPopup() {
      const popup = document.getElementById('orderPopup');
      const overlay = document.getElementById('overlay');
      if (popup && overlay) {
        popup.style.display = 'block';
        overlay.style.display = 'block';
      }
    }

    function closeOrderPopup() {
      const popup = document.getElementById('orderPopup');
      const overlay = document.getElementById('overlay');
      if (popup && overlay) {
        popup.style.display = 'none';
        overlay.style.display = 'none';
      }
    }

    function addItemRow() {
      const tableBody = document.getElementById('itemsTableBody');
      if (!tableBody) return;
      const row = document.createElement('tr');
      row.className = 'item-row';
      row.innerHTML = `
        <td><select class="item-name" onchange="updateItemPrice(this)"></select></td>
        <td><input type="number" class="item-quantity" min="1" placeholder="כמות"></td>
        <td><input type="text" class="item-price" readonly></td>
        <td><button class="remove-item" onclick="removeItemRow(this)">×</button></td>
      `;
      tableBody.appendChild(row);
      updateProductSelects();
    }

    function removeItemRow(button) {
      const row = button.closest('.item-row');
      if (row) row.remove();
    }

    async function submitOrder() {
      const customer = document.getElementById('orderCustomer')?.value;
      const contact = document.getElementById('orderContact')?.value;
      const phone = document.getElementById('orderPhone')?.value;
      const crane = document.getElementById('orderCrane')?.value;
      const street = document.getElementById('orderStreet')?.value;
      const city = document.getElementById('orderCity')?.value;
      const container = document.getElementById('orderContainer')?.value;

      const items = Array.from(document.querySelectorAll('.item-row')).map(row => ({
        name: row.querySelector('.item-name').value,
        quantity: parseInt(row.querySelector('.item-quantity').value) || 1
      }));

      if (!customer || !contact || !phone || !items.every(item => item.name && item.quantity)) {
        displayBotMessage('אנא מלא את כל השדות בטופס ההזמנה! 📋');
        return;
      }

      try {
        const response = await fetch(SCRIPT_URL, {
          method: 'POST',
          body: JSON.stringify({ action: 'saveOrder', data: { customer, contact, phone, crane, street, city, container, items } })
        });
        const result = await response.json();
        if (result.status !== 'הצלחה') throw new Error(result.message);
        displayBotMessage(`ההזמנה נשלחה בהצלחה, ${customer}! 🚛 תודה שקנית אצל ראמי!`);
        closeOrderPopup();
        await updateStats(conversation.length, document.querySelectorAll('.item-row').length);
      } catch (err) {
        console.error('Error submitting order:', err);
        displayBotMessage('אופס, לא הצלחתי לשלוח את ההזמנה... 😅 ודא שחיבור האינטרנט תקין.');
      }
    }

    function showContainerCost() {
      const container = document.getElementById('orderContainer');
      const costNote = document.getElementById('containerCost');
      if (container && costNote) {
        costNote.style.display = container.value !== 'ללא' ? 'block' : 'none';
      }
    }

    function openHowToPopup() {
      const popup = document.getElementById('howToPopup');
      const overlay = document.getElementById('overlay');
      if (popup && overlay) {
        popup.style.display = 'block';
        overlay.style.display = 'block';
      }
    }

    function closeHowToPopup() {
      const popup = document.getElementById('howToPopup');
      const overlay = document.getElementById('overlay');
      if (popup && overlay) {
        popup.style.display = 'none';
        overlay.style.display = 'none';
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      try {
        const chatBody = document.getElementById('chatBody');
        const keywordsContainer = document.getElementById('keywordsContainer');
        const userInput = document.getElementById('userInput');
        if (!chatBody || !keywordsContainer || !userInput) {
          console.error('Essential elements missing:', { chatBody, keywordsContainer, userInput });
          document.body.innerHTML = '<h1 style="color: red; text-align: center;">שגיאה: רכיבי ממשק חסרים. ודא שה-HTML תקין.</h1>';
          return;
        }

        preloadImages();
        fetchResponses();
        fetchProducts();
        keywords = fallbackKeywords;
        updateKeywords();
        displayBotMessage('<span class="welcome-message">ברוך הבא לח.סבן חומרי בניין, התלמיד 6, הוד השרון! 🏗️ איך קוראים לך? 😎</span>');
        setTimeout(() => {
          userInput.classList.add('guide');
          setTimeout(() => userInput.classList.remove('guide'), 6000);
        }, 2000);
      } catch (err) {
        console.error('Error on load:', err);
        displayBotMessage('אופס, משהו השתבש בטעינת הדף... 😅 ודא שחיבור האינטרנט תקין.');
      }
    });
  </script>
</body>
</html>

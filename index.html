<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>×¦'××˜ ×”×•×•××˜×¡××¤ ×©×œ ×¨×××™ - ×—.×¡×‘×Ÿ ×—×•××¨×™ ×‘× ×™×™×Ÿ</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #1a1a1a, #2c2c2c);
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      overflow: hidden;
    }
    .keywords-container {
      position: absolute;
      width: 900px;
      height: 900px;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      pointer-events: none;
    }
    .keyword-btn {
      position: absolute;
      padding: 14px 28px;
      background: linear-gradient(145deg, #25d366, #128c7e);
      color: white;
      border: none;
      border-radius: 30px;
      cursor: pointer;
      font-size: 16px;
      font-weight: bold;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      pointer-events: auto;
      animation: rotate360 20s linear infinite, pulse 2s ease-in-out infinite;
    }
    .keyword-btn:hover {
      transform: scale(1.15) translateY(-10px);
      box-shadow: 0 8px 30px rgba(37,211,102,0.6);
      animation-play-state: paused;
    }
    .keyword-btn:active {
      animation: throwEffect 0.5s ease forwards;
    }
    @keyframes rotate360 {
      0% { transform: rotate(0deg) translateX(400px) rotate(0deg); }
      100% { transform: rotate(360deg) translateX(400px) rotate(-360deg); }
    }
    @keyframes throwEffect {
      0% { transform: scale(1) translate(0, 0); opacity: 1; }
      50% { transform: scale(1.3) translate(80px, -80px); opacity: 0.6; }
      100% { transform: scale(0.7) translate(160px, -160px); opacity: 0; }
    }
    @keyframes pulse {
      0% { transform: scale(1); box-shadow: 0 4px 20px rgba(37,211,102,0.3); }
      50% { transform: scale(1.06); box-shadow: 0 8px 30px rgba(37,211,102,0.5); }
      100% { transform: scale(1); box-shadow: 0 4px 20px rgba(37,211,102,0.3); }
    }
    .tablet-frame {
      width: 768px;
      height: 1024px;
      background: linear-gradient(145deg, #2c2c2c, #1a1a1a);
      border-radius: 40px;
      padding: 30px;
      box-shadow: 0 30px 80px rgba(0,0,0,0.7);
      position: relative;
      z-index: 10;
      transition: transform 0.3s ease;
    }
    .tablet-frame.fullscreen {
      width: 100%;
      height: 100vh;
      border-radius: 0;
      padding: 0;
    }
    .tablet-notch {
      width: 200px;
      height: 30px;
      background: #1a1a1a;
      border-radius: 0 0 30px 30px;
      position: absolute;
      top: 15px;
      left: 50%;
      transform: translateX(-50%);
    }
    .fullscreen-btn {
      position: absolute;
      top: 20px;
      right: 20px;
      background: linear-gradient(145deg, #25d366, #128c7e);
      color: white;
      border: none;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      font-size: 20px;
      cursor: pointer;
      box-shadow: 0 4px 15px rgba(0,0,0,0.3);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .fullscreen-btn:hover {
      transform: scale(1.15);
      box-shadow: 0 8px 25px rgba(37,211,102,0.6);
    }
    .chat-container {
      width: 100%;
      height: 100%;
      background-color: #fff;
      border-radius: 30px;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      box-shadow: inset 0 0 15px rgba(0,0,0,0.1);
    }
    .chat-header {
      background: linear-gradient(145deg, #075e54, #128c7e);
      color: white;
      padding: 20px;
      display: flex;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 10;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    .chat-header img {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      margin-left: 15px;
      border: 3px solid #fff;
      transition: transform 0.3s ease;
    }
    .chat-header img:hover {
      transform: scale(1.15) rotate(12deg);
    }
    .chat-header h3 {
      margin: 0;
      font-size: 20px;
      font-weight: 600;
    }
    .chat-header .status {
      display: flex;
      align-items: center;
      margin: 0;
      font-size: 14px;
      opacity: 0.85;
    }
    .chat-header .status-dot {
      width: 12px;
      height: 12px;
      background-color: #25d366;
      border-radius: 50%;
      margin-left: 8px;
      animation: glow 1.5s ease-in-out infinite;
    }
    @keyframes glow {
      0% { box-shadow: 0 0 8px #25d366; }
      50% { box-shadow: 0 0 20px #25d366; }
      100% { box-shadow: 0 0 8px #25d366; }
    }
    .chat-body {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
      background: url('https://theverifier.co.il/wp-content/uploads/2019/02/whatsapp-promo-1024x538.png') repeat;
      background-size: cover;
      background-color: rgba(255,255,255,0.9);
      scroll-behavior: smooth;
    }
    .message {
      margin: 12px 0;
      padding: 14px 20px;
      border-radius: 14px;
      max-width: 75%;
      position: relative;
      animation: slideIn 0.3s ease-out;
      word-wrap: break-word;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
      transition: transform 0.2s ease;
    }
    .message:hover {
      transform: scale(1.03);
    }
    .user-message {
      background: linear-gradient(145deg, #dcf8c6, #b3e0a3);
      align-self: flex-end;
      margin-left: 15px;
      border-bottom-right-radius: 4px;
    }
    .bot-message {
      background: linear-gradient(145deg, #ffffff, #f0f0f0);
      align-self: flex-start;
      margin-right: 15px;
      border-bottom-left-radius: 4px;
    }
    .message-time {
      font-size: 12px;
      color: #666;
      position: absolute;
      bottom: 8px;
      left: 14px;
      opacity: 0.75;
    }
    .message-image {
      max-width: 250px;
      border-radius: 14px;
      border: 3px solid #075e54;
      margin-top: 8px;
      transition: transform 0.2s ease;
    }
    .message-image:hover {
      transform: scale(1.06);
    }
    .chat-footer {
      display: flex;
      padding: 15px;
      background: linear-gradient(145deg, #f0f0f0, #e0e0e0);
      border-top: 1px solid #ddd;
      position: relative;
      align-items: center;
    }
    .chat-footer input {
      flex: 1;
      padding: 16px 28px;
      border: none;
      border-radius: 30px;
      background: #fff;
      box-shadow: 0 4px 15px rgba(0,0,0,0.15);
      font-size: 16px;
      max-width: 65%;
      transition: box-shadow 0.2s ease, transform 0.2s ease;
    }
    .chat-footer input:focus {
      box-shadow: 0 4px 20px rgba(37,211,102,0.4);
      transform: scale(1.02);
      outline: none;
    }
    .chat-footer button {
      padding: 16px;
      border: none;
      background: linear-gradient(145deg, #25d366, #128c7e);
      color: white;
      border-radius: 50%;
      cursor: pointer;
      margin-right: 15px;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }
    .chat-footer button:hover {
      transform: scale(1.15);
      box-shadow: 0 8px 25px rgba(37,211,102,0.6);
    }
    .attach-btn {
      background: none;
      color: #075e54;
      font-size: 24px;
      margin-right: 15px;
    }
    .attach-menu {
      display: none;
      position: absolute;
      bottom: 80px;
      right: 15px;
      background: #fff;
      border-radius: 20px;
      box-shadow: 0 8px 30px rgba(0,0,0,0.3);
      padding: 15px;
      animation: slideDown 0.3s ease;
      z-index: 10;
    }
    .attach-menu button {
      display: block;
      width: 100%;
      padding: 14px;
      background: none;
      border: none;
      text-align: right;
      color: #075e54;
      cursor: pointer;
      font-size: 16px;
      transition: background 0.2s ease;
    }
    .attach-menu button:hover {
      background: #f0f0f0;
      border-radius: 12px;
    }
    .file-upload {
      display: none;
      position: relative;
    }
    .file-upload input {
      display: none;
    }
    .upload-progress {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 70px;
      height: 70px;
      border: 8px solid #f0f0f0;
      border-top: 8px solid #25d366;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      display: none;
    }
    @keyframes spin {
      0% { transform: translate(-50%, -50%) rotate(0deg); }
      100% { transform: translate(-50%, -50%) rotate(360deg); }
    }
    .typing {
      display: flex;
      align-items: center;
      padding: 14px;
      background: #fff;
      border-radius: 14px;
      margin: 12px 15px;
      max-width: 75%;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }
    .typing span {
      width: 12px;
      height: 12px;
      background: linear-gradient(145deg, #25d366, #128c7e);
      border-radius: 50%;
      margin: 0 5px;
      animation: bounce 0.6s infinite alternate, fade 0.6s infinite alternate;
    }
    .typing span:nth-child(2) {
      animation-delay: 0.2s;
    }
    .typing span:nth-child(3) {
      animation-delay: 0.4s;
    }
    @keyframes bounce {
      from { transform: translateY(0); }
      to { transform: translateY(-8px); }
    }
    @keyframes fade {
      from { opacity: 1; }
      to { opacity: 0.4; }
    }
    .order-popup {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(0.8);
      background: linear-gradient(145deg, #ffffff, #f5f5f5);
      padding: 40px;
      border-radius: 30px;
      box-shadow: 0 15px 50px rgba(0,0,0,0.5);
      z-index: 100;
      width: 600px;
      max-height: 90vh;
      overflow-y: auto;
      animation: zoomIn 0.3s ease forwards;
      border: 1px solid rgba(37,211,102,0.2);
    }
    .order-popup h3 {
      margin: 0 0 30px;
      color: #075e54;
      text-align: center;
      font-size: 24px;
      font-weight: 600;
      text-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .order-popup label {
      display: block;
      margin: 20px 0 8px;
      font-size: 16px;
      color: #333;
      font-weight: 500;
    }
    .order-popup input, .order-popup select {
      width: 100%;
      padding: 14px;
      border: 1px solid #ddd;
      border-radius: 14px;
      font-size: 16px;
      background: #fff;
      box-shadow: inset 0 1px 4px rgba(0,0,0,0.1);
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }
    .order-popup input:focus, .order-popup select:focus {
      border-color: #25d366;
      box-shadow: 0 0 15px rgba(37,211,102,0.4);
      outline: none;
    }
    .order-popup .corrected {
      color: #25d366;
      background: #25d36611;
      animation: highlight 0.5s ease;
    }
    @keyframes highlight {
      0% { background: #25d36633; }
      100% { background: #25d36611; }
    }
    .order-popup .cost-note {
      font-size: 14px;
      color: #ff4444;
      margin-right: 15px;
      animation: fadeIn 0.5s ease;
      display: inline-block;
    }
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    .order-popup .items-list {
      margin-top: 30px;
      background: #f9f9f9;
      padding: 20px;
      border-radius: 14px;
    }
    .order-popup .item-row {
      display: flex;
      align-items: center;
      margin-bottom: 20px;
      animation: slideIn 0.3s ease;
    }
    .order-popup .item-row input {
      width: 60%;
      margin-left: 15px;
    }
    .order-popup .item-row input[type="number"] {
      width: 30%;
    }
    .order-popup .remove-item {
      background: #ff4444;
      color: white;
      border: none;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      transition: transform 0.2s ease;
    }
    .order-popup .remove-item:hover {
      transform: scale(1.15);
    }
    .order-popup button {
      width: 100%;
      padding: 16px;
      background: linear-gradient(145deg, #25d366, #128c7e);
      color: white;
      border: none;
      border-radius: 20px;
      cursor: pointer;
      margin-top: 20px;
      font-size: 18px;
      font-weight: 600;
      box-shadow: 0 4px 20px rgba(0,0,0,0.2);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .order-popup button:hover {
      transform: scale(1.05);
      box-shadow: 0 8px 30px rgba(37,211,102,0.5);
    }
    .order-popup .close-btn {
      background: linear-gradient(145deg, #ff6666, #cc0000);
    }
    .order-popup .close-btn:hover {
      box-shadow: 0 8px 30px rgba(255,102,102,0.5);
    }
    .overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.6);
      z-index: 99;
      backdrop-filter: blur(4px);
    }
    @keyframes slideIn {
      from { transform: translateX(30px); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    @keyframes slideDown {
      from { transform: translateY(-30px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    @keyframes zoomIn {
      from { transform: translate(-50%, -50%) scale(0.8); opacity: 0; }
      to { transform: translate(-50%, -50%) scale(1); opacity: 1; }
    }
    @keyframes fadeOut {
      from { opacity: 1; }
      to { opacity: 0; }
    }
    @media (max-width: 800px) {
      .tablet-frame {
        width: 100%;
        height: 100vh;
        border-radius: 0;
        padding: 0;
      }
      .tablet-notch, .fullscreen-btn {
        display: none;
      }
      .chat-container {
        border-radius: 0;
      }
      .keywords-container {
        width: 100%;
        height: auto;
        top: auto;
        bottom: 30px;
        transform: none;
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 15px;
      }
      .keyword-btn {
        position: static;
        animation: none;
        transform: none;
        padding: 12px 24px;
        font-size: 14px;
      }
      .order-popup {
        width: 95%;
        padding: 20px;
      }
      .chat-footer input {
        max-width: 60%;
        padding: 12px 20px;
        font-size: 14px;
      }
      .chat-footer button {
        padding: 12px;
        margin-right: 10px;
      }
      .chat-header img {
        width: 40px;
        height: 40px;
        margin-left: 10px;
      }
      .chat-header h3 {
        font-size: 18px;
      }
      .message {
        max-width: 80%;
        padding: 12px 16px;
        font-size: 14px;
      }
      .message-image {
        max-width: 200px;
      }
    }
  </style>
</head>
<body>
  <div class="keywords-container" id="keywordsContainer"></div>
  <div class="tablet-frame" id="tabletFrame">
    <div class="tablet-notch"></div>
    <button class="fullscreen-btn" onclick="toggleFullscreen()">ğŸ”²</button>
    <div class="chat-container">
      <div class="chat-header">
        <img src="https://i.postimg.cc/t4Q91FDQ/Screenshot-20250427-160448-Whats-App-Business.jpg" alt="×¨×××™" onerror="this.src='https://via.placeholder.com/50';">
        <div>
          <h3>×•×•××˜×¡××¤ ×©×œ ×¨×××™ - ×—.×¡×‘×Ÿ</h3>
          <p class="status"><span class="status-dot"></span> ××—×•×‘×¨</p>
        </div>
      </div>
      <div class="chat-body" id="chatBody">
        <div class="message bot-message">
          ×‘×¨×•×š ×”×‘× ×œ×—.×¡×‘×Ÿ ×—×•××¨×™ ×‘× ×™×™×Ÿ, ×”×ª×œ××™×“ 6, ×”×•×“ ×”×©×¨×•×Ÿ! ğŸ—ï¸ ××™×š ×§×•×¨××™× ×œ×š? ğŸ˜
          <span class="message-time"></span>
        </div>
      </div>
      <div class="chat-footer">
        <button class="attach-btn" onclick="toggleAttachMenu()">ğŸ“</button>
        <div class="attach-menu" id="attachMenu">
          <button onclick="document.getElementById('fileInput').click()">×¦×¨×£ ××¡××š ğŸ“„</button>
          <button onclick="shareLocation()">×©×ª×£ ××™×§×•× ğŸ“</button>
          <button onclick="addToCalendar()">×¦×•×¨ ××™×¨×•×¢ ğŸ“…</button>
          <button onclick="document.getElementById('fileInput').click()">×¦×œ× ×ª××•× ×” ğŸ“·</button>
        </div>
        <input type="text" id="userInput" placeholder="×”×§×œ×“ ×”×•×“×¢×”..." onkeypress="if(event.key === 'Enter') sendMessage()">
        <button onclick="sendMessage()">â¤</button>
      </div>
      <div class="file-upload">
        <input type="file" id="fileInput" accept="image/*,application/pdf" onchange="uploadFile()">
        <div class="upload-progress" id="uploadProgress"></div>
      </div>
    </div>
  </div>
  <div class="overlay" id="overlay"></div>
  <div class="order-popup" id="orderPopup">
    <h3>×˜×•×¤×¡ ×”×–×× ×” ×™×•×§×¨×ª×™ ğŸ“¦</h3>
    <label>×©× ×œ×§×•×— (×¢×œ ×”×—×©×‘×•× ×™×ª):</label>
    <input type="text" id="orderCustomer" placeholder="×œ××©×œ: ×™×•×¡×™ ×›×”×Ÿ">
    <label>××™×© ×§×©×¨:</label>
    <input type="text" id="orderContact" placeholder="×œ××©×œ: ×™×•×¡×™">
    <label>× ×™×™×“:</label>
    <input type="tel" id="orderPhone" placeholder="×œ××©×œ: 0501234567">
    <label>×¡×•×’ ×× ×•×£:</label>
    <select id="orderCrane">
      <option value="××©××™×ª ×× ×•×£">××©××™×ª ×× ×•×£</option>
      <option value="×× ×•×£ 15 ××˜×¨">×× ×•×£ 15 ××˜×¨</option>
      <option value="×œ×œ×">×œ×œ×</option>
    </select>
    <label>×¨×—×•×‘:</label>
    <input type="text" id="orderStreet" placeholder="×œ××©×œ: ×”×ª×œ××™×“ 6">
    <label>×¢×™×¨:</label>
    <input type="text" id="orderCity" placeholder="×œ××©×œ: ×”×•×“ ×”×©×¨×•×Ÿ">
    <label>×¤×¢×•×œ×ª ××›×•×œ×”:</label>
    <select id="orderContainer" onchange="showContainerCost()">
      <option value="×œ×œ×">×œ×œ×</option>
      <option value="×”×¦×‘×ª ××›×•×œ×”">×”×¦×‘×ª ××›×•×œ×”</option>
      <option value="×”×—×œ×¤×ª ××›×•×œ×”">×”×—×œ×¤×ª ××›×•×œ×”</option>
      <option value="×”×•×¦××ª ××›×•×œ×”">×”×•×¦××ª ××›×•×œ×”</option>
    </select>
    <span class="cost-note" id="containerCost" style="display: none;">×¢×œ×•×ª: 1416 ×©"×— ×›×•×œ×œ ××¢"× ×¢×“ 10 ×™××™ ×©×›×™×¨×•×ª</span>
    <div class="items-list">
      <h4>×¤×¨×™×˜×™×:</h4>
      <div class="item-row">
        <input type="text" placeholder="×¤×¨×™×˜, ×œ××©×œ: ×‘×œ×•×§×™×" class="item-name">
        <input type="number" placeholder="×›××•×ª" class="item-quantity">
        <button class="remove-item" onclick="removeItemRow(this)">Ã—</button>
      </div>
    </div>
    <button onclick="addItemRow()">×”×•×¡×£ ×¤×¨×™×˜ +</button>
    <button onclick="submitOrder()">×©×œ×— ×”×–×× ×” ğŸš›</button>
    <button class="close-btn" onclick="closeOrderPopup()">×¡×’×•×¨</button>
  </div>

  <script>
    const express = require('express');
const { google } = require('googleapis');
const cors = require('cors');
require('dotenv').config();

const app = express();
app.use(cors());
app.use(express.json());

// ×”×’×“×¨×ª Google Sheets API
const sheets = google.sheets('v4');
const auth = new google.auth.GoogleAuth({
  keyFile: process.env.GOOGLE_CREDENTIALS, // ×§×•×‘×¥ JSON ××”×“××©×‘×•×¨×“ ×©×œ Google Cloud
  scopes: ['https://www.googleapis.com/auth/spreadsheets.readonly'],
});

// × ×ª×™×‘ ×œ×©×œ×™×¤×ª × ×ª×•× ×™× ××”×’×™×œ×™×•×Ÿ
app.get('/api/products', async (req, res) => {
  try {
    const authClient = await auth.getClient();
    const spreadsheetId = process.env.SPREADSHEET_ID;'13fP3cH_npVSYz-cHZWL27-cGwHldBP3VdnBdFZq4wN0' // ×”-ID ×©×œ ×”×’×™×œ×™×•×Ÿ
    const range = 'Sheet1!A1:D1000'; // ×”×˜×•×•×— ×”×¨×¦×•×™

    const response = await sheets.spreadsheets.values.get({
      auth: authClient,
      spreadsheetId,
      range,
    });

    res.json(response.data.values);
  } catch (error) {
    console.error('×©×’×™××” ×‘×©×œ×™×¤×ª ××•×¦×¨×™×:', error);
    res.status(403).json({ error: '××™×Ÿ ×”×¨×©××” ×œ×’×©×ª ×œ×’×™×œ×™×•×Ÿ' });
  }
});

// × ×ª×™×‘ ×‘×¡×™×¡×™ ×œ×‘×“×™×§×ª ×¤×¢×™×œ×•×ª ×”×©×¨×ª
app.get('/', (req, res) => {
  res.send('×”×©×¨×ª ×¤×¢×™×œ!');
});

const PORT = process.env.PORT || 3000;
app.listen(PORT, () => {
  console.log(`×”×©×¨×ª ×¨×¥ ×¢×œ ×¤×•×¨×˜ ${PORT}`);
});


const nameData = {
  '×•×¨×“': {
    traits: '×–×•×¨×—×ª ×›××• ×¤×¨×—, ××œ××ª ×—×™×™× ×•×× ×¨×’×™×”!',
    ramiThought: '×•×¨×“ ×”×™× ×›××• ×‘×œ×•×§ ××•×©×œ× â€“ ×™×¤×”, ×—×–×§×”, ×•×ª××™×“ ××•×¡×™×¤×” ×¦×‘×¢! ğŸŒ¹',
    quip: '×•×¨×“, ×¢× ×©× ×›×–×”, ××ª ×‘×˜×— ×©×•×‘×¨×ª ×œ×‘×‘×•×ª ×‘××—×¡×Ÿ! ğŸ˜œ'
  },
  '×ª××™×¨': {
    traits: '××¢×•×“×“, ×ª××™×“ ×¢× ×—×™×•×š, ××—×¡× ××™ ××¡×¤×¨ ××—×ª!',
    ramiThought: '×ª××™×¨ ×”×•× ×”×—×‘×¨ ×©×ª××™×“ ×©× ×›×©×”××©××¨×ª × ×”×™×™×ª ×§×©×”! ğŸ’ª',
    quip: '×ª××™×¨, ××ª×” ××¢×•×“×“ ××ª ×›×•×œ×, ××‘×œ ××™ ××¢×•×“×“ ××•×ª×š ×›×©××©×¨ ×©×•×‘ ××“×¤×™×¡ ××ª ×”×©×‘×•×¢? ğŸ˜…'
  },
  '××•×¨×Ÿ': {
    traits: '×—×‘×™×‘, ×ª×•×ª×— ×¢×œ ×”××œ×’×–×”, ×§×¦×ª ×’××“ ××‘×œ ×¢× ×§ ×‘×œ×‘!',
    ramiThought: '××•×¨×Ÿ ×“×•×¤×§ ×¢×‘×•×“×” ×›×©×¦×¨×™×š, ××‘×œ ×œ×¤×¢××™× ×¦×¨×™×š ×œ×“×—×•×£ ××•×ª×• ×§×¦×ª! ğŸšœ',
    quip: '××•×¨×Ÿ, ×’××“×’××“, ××‘×œ ×›×©××ª×” ×¢×œ ×”××œ×’×–×”, ××ª×” ××œ×š ×”××—×¡×Ÿ! ğŸ˜'
  },
  '×¢×œ×': {
    traits: '×—×‘×¨×•×ª×™, ×ª××™×“ ×¢× ×¡×™×¤×•×¨ ×˜×•×‘, ××¨×™× ××ª ×”××•×¨×œ!',
    ramiThought: '×¢×œ× ××‘×™× ××ª ×”×× ×¨×’×™×”, ×›××• ××©××™×ª ××œ××” ×‘×œ×•×§×™×! ğŸšš',
    quip: '×¢×œ×, ×¢× ×”×¡×™×¤×•×¨×™× ×©×œ×š, ××ª×” ×¦×¨×™×š ×¤×•×“×§××¡×˜ ×‘××—×¡×Ÿ! ğŸ™ï¸'
  },
  '×¢×œ×™': {
    traits: '× ×××Ÿ, ×¢×•×‘×“ ×§×©×”, ×ª××™×“ × ×•×ª×Ÿ 100%!',
    ramiThought: '×¢×œ×™ ×”×•× ×›××• ××œ×˜ â€“ ××—×–×™×§ ×”×›×œ ×‘×™×—×“! ğŸ§±',
    quip: '×¢×œ×™, ××ª×” ×¢×•×‘×“ ×›×œ ×›×š ×§×©×”, ××¤×™×œ×• ×”××œ×’×–×” ××‘×§×©×ª ×”×¤×¡×§×”! ğŸ˜œ'
  },
  '×™×•××‘': {
    traits: '×—×›×, ×™×¦×™×¨×ª×™, ×ª××™×“ ×¢× ×¤×ª×¨×•×Ÿ ×œ×›×œ ×‘×¢×™×”!',
    ramiThought: '×™×•××‘ ×”×•× ×”×¨××© ×”×—×•×©×‘ ×©×œ ×”××—×¡×Ÿ, ×›××• ××”× ×“×¡ ×‘×œ×•×§×™×! ğŸ§ ',
    quip: '×™×•××‘, ×¢× ×”×¨××© ×©×œ×š, ××ª×” ×ª××¦×™× ×‘×œ×•×§ ×©××¨×›×™×‘ ××ª ×¢×¦××•! ğŸ˜…'
  },
  '× ×ª× ××œ': {
    traits: '×¨×’×•×¢, ×××™×Ÿ, ×ª××™×“ ×©×•××¨ ×¢×œ ×§×•×¨ ×¨×•×—!',
    ramiThought: '× ×ª× ××œ ×”×•× ×›××• ××™× ×‘×™×•× ×—× â€“ ××¨×’×™×¢ ××ª ×›×•×œ×! ğŸ’§',
    quip: '× ×ª× ××œ, ××ª×” ×›×œ ×›×š ×¨×’×•×¢, ××¤×™×œ×• ××©×¨ ×œ× ××¦×œ×™×— ×œ×”×•×¦×™× ××•×ª×š ××”×§×¦×‘! ğŸ˜'
  },
  '×“×•×¨×•×Ÿ': {
    traits: '× ×“×™×‘, ×ª××™×“ ×¢×•×–×¨, ×œ×‘ ×–×”×‘!',
    ramiThought: '×“×•×¨×•×Ÿ ×”×•× ×›××• ××©××™×ª ×©××‘×™××” ××ª ×›×œ ×”×˜×•×‘ ×œ××—×¡×Ÿ! ğŸš›',
    quip: '×“×•×¨×•×Ÿ, ×¢× ×”×œ×‘ ×©×œ×š, ××ª×” ×™×›×•×œ ×œ××›×•×¨ ×‘×œ×•×§×™× ×‘×—×™× × ×•×¢×“×™×™×Ÿ ×œ×”×¨×•×•×™×—! ğŸ˜œ'
  },
  '×œ×™× ×”': {
    traits: '××”×•×‘×ª ×œ×‘×• ×©×œ ×¨×××™, ××§×¡×™××” ×•××œ××ª ×§×¡×!',
    ramiThought: '×œ×™× ×” ×”×™× ×”×œ×‘ ×©×œ ×”××—×¡×Ÿ, ×›×œ ×™×•× ××™×ª×” ×”×•× ×›××• ×—×’! ğŸ’–',
    quip: '×œ×™× ×”, ×¨×××™ ××•××¨ ×©××ª ×”×‘×œ×•×§ ×”×›×™ ×™×¤×” ×‘××—×¡×Ÿ! ğŸ˜'
  },
  '×©×¨×•×Ÿ': {
    traits: '×¦×¨×¤×ª×™×” ××¨×¢× × ×”, ×ª××™×“ ×¢× ×¡×˜×™×™×œ ×•×—×™×•×š!',
    ramiThought: '×©×¨×•×Ÿ ××‘×™××” ×§×œ××¡×” ×œ××—×¡×Ÿ, ×›××• ×¦×‘×¢ ×¤×¨×™××™×•×! ğŸ¨',
    quip: '×©×¨×•×Ÿ, ×¢× ×”×¡×˜×™×™×œ ×©×œ×š, ××ª ×™×›×•×œ×” ×œ××›×•×¨ ×‘×œ×•×§×™× ×‘×ª×¦×•×’×ª ××•×¤× ×”! ğŸ˜…'
  },
  '××©×¨': {
    traits: '××©×’×¢ ××ª ×›×•×œ× ×¢× ×”×“×¤×¡×•×ª ×”×©×‘×•×¢, ××‘×œ ×ª××™×“ ××¦×—×™×§!',
    ramiThought: '××©×¨ ×”×•× ×›××• ××©××™×ª ×©×œ× ×§×•×¨××ª ××ª ×”××¡×œ×•×œ, ××‘×œ ×‘×¡×•×£ ××’×™×¢! ğŸ“„',
    quip: '××©×¨, ×ª×¤×¡×™×§ ×œ×”×“×¤×™×¡ ××ª ×”×©×‘×•×¢, ×¨×××™ ×›×‘×¨ ×œ× ×™×›×•×œ ×œ×¨××•×ª × ×™×™×¨! ğŸ˜œ'
  }
};

// ×˜×¢×™× ×ª ×ª××•× ×•×ª ×¢× ×’×™×‘×•×™
function preloadImages() {
  const images = [
    { src: 'https://i.postimg.cc/t4Q91FDQ/Screenshot-20250427-160448-Whats-App-Business.jpg', fallback: 'https://via.placeholder.com/380x760?text=WhatsApp+Background' },
    { src: 'https://i.postimg.cc/3J9Y4b0Z/blocks.jpg', fallback: 'https://via.placeholder.com/24?text=Stylus' },
    { src: 'https://i.postimg.cc/5y3t8QzT/paint.jpg', fallback: 'https://via.placeholder.com/220?text=Paint' },
    { src: 'https://i.postimg.cc/4yqP2R9Z/tools.jpg', fallback: 'https://via.placeholder.com/220?text=Tools' }
  ];
  images.forEach(image => {
    const img = new Image();
    img.src = image.src;
    img.onerror = () => { img.src = image.fallback; };
  });
}
function getProducts() {
  return getSheetData({
    id: '1T14O3eVJzJqBXe6pr5flLckvpM4TGRycTYp5Elq2KSY',
    sheetName: '××•×¦×¨×™×',
    columns: ['id', 'name', 'category', 'price', 'stock']
  });
}

// ×©×œ×™×¤×ª ×©××œ×•×ª ×•×ª×©×•×‘×•×ª
async function fetchResponses() {
  try {
    const sheetId = '13fP3cH_npVSYz-cHZWL27-cGwHldBP3VdnBdFZq4wN0';
    const response = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${sheetId}/values/Sheet1!A1:D1000?key=${AIzaSyCNn7GZMsQPCdRSfgz_o08M1YV63CkA3Ow}`);
    const data = await response.json();
    if (!data.values || data.values.length < 2) throw new Error('No responses found');
    responses = data.values.slice(1).map(row => ({
      question: row[0] || '',
      answer: row[1] || '',
      keywords: row[2] ? row[2].split(',').map(k => k.trim()) : [],
      synonyms: row[3] ? row[3].split(',').map(s => s.trim()) : []
    }));
    keywords = responses.map(r => ({ label: r.question, question: r.question }));
    updateKeywords();
  } catch (err) {
    console.error('Error fetching responses:', err);
    displayBotMessage('××•×¤×¡, ×œ× ×”×¦×œ×—×ª×™ ×œ×˜×¢×•×Ÿ ××ª ×”×ª×©×•×‘×•×ª... ğŸ˜… ×•×“× ×©×—×™×‘×•×¨ ×”××™× ×˜×¨× ×˜ ×ª×§×™×Ÿ ×•× ×¡×” ×©×•×‘.');
  }
}

// ×©×œ×™×¤×ª ××•×¦×¨×™×
async function fetchProducts() {
  try {
    const sheetId = '1T14O3eVJzJqBXe6pr5flLckvpM4TGRycTYp5Elq2KSY';
    const response = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${sheetId}/values/Sheet1!A1:E1000?key=${AIzaSyCNn7GZMsQPCdRSfgz_o08M1YV63CkA3Ow}`);
    const data = await response.json();
    if (!data.values || data.values.length < 2) throw new Error('No products found');
    products = data.values.slice(1).map(row => ({
      name: row[0] || '',
      category: row[1] || '',
      price: parseFloat(row[2]) || 0,
      stock: parseInt(row[3]) || 0,
      description: row[4] || ''
    }));
    updateProductSelects();
  } catch (err) {
    console.error('Error fetching products:', err);
    displayBotMessage('××•×¤×¡, ×œ× ×”×¦×œ×—×ª×™ ×œ×˜×¢×•×Ÿ ××ª ×”××•×¦×¨×™×... ğŸ˜… ×•×“× ×©×—×™×‘×•×¨ ×”××™× ×˜×¨× ×˜ ×ª×§×™×Ÿ ×•× ×¡×” ×©×•×‘.');
  }
}

// ×¢×“×›×•×Ÿ ×ª×™×‘×•×ª ×‘×—×™×¨×ª ××•×¦×¨×™×
function updateProductSelects() {
  try {
    const selects = document.querySelectorAll('.item-name');
    selects.forEach(select => {
      select.innerHTML = '<option value="">×‘×—×¨ ××•×¦×¨</option>' + products.map(product => 
        `<option value="${product.name}" data-price="${product.price}" data-stock="${product.stock}">${product.name} (${product.stock} ×‘××œ××™)</option>`
      ).join('');
    });
  } catch (err) {
    console.error('Error updating product selects:', err);
  }
}

// ×¢×“×›×•×Ÿ ××—×™×¨ ×¤×¨×™×˜
function updateItemPrice(select) {
  try {
    const row = select.closest('.item-row');
    const priceInput = row.querySelector('.item-price');
    const selectedOption = select.options[select.selectedIndex];
    const price = selectedOption ? selectedOption.getAttribute('data-price') : '';
    priceInput.value = price ? `${price} ×©"×—` : '';
  } catch (err) {
    console.error('Error updating item price:', err);
  }
}

// ×©××™×¨×ª ××©×ª××©
async function saveUser(name, phone) {
  try {
    const response = await fetch(SCRIPT_URL, {
      method: 'POST',
      body: JSON.stringify({ action: 'saveUser', data: { name, phone } })
    });
    const result = await response.json();
    if (result.status !== '×”×¦×œ×—×”') throw new Error(result.message);
  } catch (err) {
    console.error('Error saving user:', err);
    displayBotMessage('××•×¤×¡, ×œ× ×”×¦×œ×—×ª×™ ×œ×©××•×¨ ××ª ×”××©×ª××©... ğŸ˜… × ×¡×” ×©×•×‘ ×××•×—×¨ ×™×•×ª×¨.');
  }
}

// ×©××™×¨×ª ×©×™×—×ª ×¦'××˜
async function saveChat(userName, question, answer) {
  try {
    const response = await fetch(SCRIPT_URL, {
      method: 'POST',
      body: JSON.stringify({ action: 'saveChat', data: { userName, question, answer } })
    });
    const result = await response.json();
    if (result.status !== '×”×¦×œ×—×”') throw new Error(result.message);
  } catch (err) {
    console.error('Error saving chat:', err);
  }
}

// ×¢×“×›×•×Ÿ ×¡×˜×˜×™×¡×˜×™×§×•×ª
async function updateStats(messageCount, orderCount) {
  try {
    const response = await fetch(SCRIPT_URL, {
      method: 'POST',
      body: JSON.stringify({ action: 'updateStats', data: { messageCount, orderCount } })
    });
    const result = await response.json();
    if (result.status !== '×”×¦×œ×—×”') throw new Error(result.message);
  } catch (err) {
    console.error('Error updating stats:', err);
  }
}

// ×”×•×¡×¤×ª ×ª×•×›×Ÿ ×œ×××’×¨ ×©××œ×•×ª ×•×ª×©×•×‘×•×ª
async function addToResponses(question, answer, keywords = [], synonyms = []) {
  try {
    const response = await fetch(SCRIPT_URL, {
      method: 'POST',
      body: JSON.stringify({
        action: 'addResponse',
        data: { question, answer, keywords: keywords.join(','), synonyms: synonyms.join(',') }
      })
    });
    const result = await response.json();
    if (result.status !== '×”×¦×œ×—×”') throw new Error(result.message);
    responses.push({ question, answer, keywords, synonyms });
    keywords.push({ label: question, question });
    updateKeywords();
  } catch (err) {
    console.error('Error adding to responses:', err);
  }
}

// ×©×œ×™×—×ª ×”×•×“×¢×”
async function sendMessage(inputText = null) {
  try {
    const userInput = document.getElementById('userInput');
    const message = inputText || userInput.value.trim();
    if (!message) return;

    displayUserMessage(message);
    userInput.value = '';
    moveStylus();

    if (!userName) {
      userName = message;
      await saveUser(userName, userPhone);
      displayBotMessage(`× ×¢×™× ×œ×”×›×™×¨, ${userName}! ğŸ˜ ×× ×™ ×¨×××™, ×”×‘×•×˜ ×©×œ ×—.×¡×‘×Ÿ ×—×•××¨×™ ×‘× ×™×™×Ÿ!`);
      if (nameData[userName]) {
        const nameInfo = nameData[userName];
        displayBotMessage(`<span class="name-prompt">×ª×¨×¦×” ×©××’×œ×” ×œ×š ××” ××•××¨ ×”×©× ×©×œ×š ×¢×“ ×©×¨×××™ ×™×¢× ×”? ğŸ˜</span>`);
        namePrompted = true;
      } else {
        displayBotMessage('××™×š ××¤×©×¨ ×œ×¢×–×•×¨ ×œ×š ×”×™×•×? ğŸ—ï¸');
        updateKeywords();
      }
      return;
    }

    if (namePrompted && (message.toLowerCase().includes('×›×Ÿ') || message.toLowerCase().includes('×‘×˜×—'))) {
      namePrompted = false;
      await handleNamePrediction(userName);
      return;
    }

    showTypingIndicator();
    const response = findResponse(message);
    setTimeout(async () => {
      hideTypingIndicator();
      displayBotMessage(response);
      await saveChat(userName, message, response);
      await updateStats(conversation.length, document.querySelectorAll('.item-row').length);
      if (nameData[userName] && Math.random() < 0.3) {
        displayBotMessage(nameData[userName].quip);
      }
    }, 1000);

  } catch (err) {
    console.error('Error sending message:', err);
    displayBotMessage('××•×¤×¡, ××©×”×• ×”×©×ª×‘×©... ğŸ˜… ×•×“× ×©×—×™×‘×•×¨ ×”××™× ×˜×¨× ×˜ ×ª×§×™×Ÿ ×•× ×¡×” ×©×•×‘.');
  }
}

// ×˜×™×¤×•×œ ×‘×—×™×–×•×™ ×©×
async function handleNamePrediction(name) {
  try {
    if (name === '×•×¨×“') {
      const motivation = [
        '×•×¨×“, ××ª ×›××• ×¤×¨×— ×©×¤×•×¨×— ×‘×›×œ ××¦×‘! ğŸŒ¹',
        '×”×©× ×©×œ×š ××‘×™× ××•×¨ ×œ×›×œ ××—×¡×Ÿ, ×ª××©×™×›×™ ×œ×–×¨×•×—!',
        '×•×¨×“, ×”×›×•×— ×©×œ×š ×”×•× ×›××• ×‘×œ×•×§ â€“ ××™ ××¤×©×¨ ×œ×©×‘×•×¨ ××•×ª×•!',
        '××ª ××œ××ª ×× ×¨×’×™×”, ×•×¨×“, ×›××• ××©××™×ª ×©×“×•×”×¨×ª!',
        '×•×¨×“, ××ª ×”×©×¨××” ×œ×›×œ ××™ ×©×¤×•×’×© ××•×ª×š!',
        '×”×—×™×•×š ×©×œ×š, ×•×¨×“, ×©×•×•×” ×™×•×ª×¨ ××›×œ ×”×‘×œ×•×§×™× ×‘××—×¡×Ÿ!',
        '×•×¨×“, ××ª ×›××• ×¦×‘×¢ ×¤×¨×™××™×•× â€“ ×ª××™×“ ××•×¡×™×¤×” ×¡×˜×™×™×œ!',
        '×”×©× ×©×œ×š ×”×•× ×¡××œ ×œ×—×•×–×§ ×•×™×•×¤×™, ×ª××©×™×›×™ ×›×š!',
        '×•×¨×“, ××ª ×ª××™×“ ××¦×œ×™×—×” ×œ×”×¤×•×š ×™×•× ×§×©×” ×œ×–×¨×™×—×”!',
        '××ª ×›××• ××œ×˜, ×•×¨×“ â€“ ××—×‘×¨×ª ××ª ×›×•×œ×!',
        '×•×¨×“, ×™×© ×œ×š ××ª ×”×›×•×— ×œ×©× ×•×ª ×›×œ ×¡×™×˜×•××¦×™×”!',
        '×”×œ×‘ ×©×œ×š, ×•×¨×“, ×’×“×•×œ ×›××• ××©××™×ª ×©×œ ×—.×¡×‘×Ÿ!',
        '×•×¨×“, ××ª ×ª××™×“ ××‘×™××” ××ª ×”×× ×¨×’×™×” ×”×›×™ ×˜×•×‘×”!',
        '×”×©× ×©×œ×š ×”×•× ×›××• ×©××© ×©×××™×¨×” ××ª ×”××—×¡×Ÿ!',
        '×•×¨×“, ××ª ×›××• ×›×œ×™ ×¢×‘×•×“×” ××™×›×•×ª×™ â€“ ×ª××™×“ ×¢×•×©×” ××ª ×”×¢×‘×•×“×”!',
        '××ª ××œ××ª ×—×™×™×, ×•×¨×“, ×›××• ×’×™× ×” ×¤×•×¨×—×ª!',
        '×•×¨×“, ××ª ×ª××™×“ ×™×•×“×¢×ª ××™×š ×œ×”×¨×™× ××ª ×”××•×¨×œ!',
        '×”×›×•×— ×©×œ×š, ×•×¨×“, ×”×•× ×›××• ×× ×•×£ 50 ×˜×•×Ÿ!',
        '×•×¨×“, ××ª ×›××• ×‘×œ×•×§ ××•×©×œ× â€“ ×—×–×§×” ×•×™×¤×”!',
        '×”×©× ×©×œ×š, ×•×¨×“, ×”×•× ×¡××œ ×œ×”×¦×œ×—×” ×‘×›×œ ××©×™××”!'
      ];
      const encouragement = [
        '×•×¨×“, ×‘×¢×‘×•×“×” ××ª ×ª××™×“ ×ª×–×¨×—×™ ×›××• ×›×•×›×‘! ğŸŒŸ',
        '×”×™×œ×“×™× ×©×œ×š ×‘×˜×— ×’××™× ×‘×š, ×•×¨×“, ××ª ××× ××“×”×™××”!',
        '×•×¨×“, ×ª××©×™×›×™ ×œ× ×”×œ ××ª ×”×›×œ ×›××• ×‘×•×¡×™×ª ×‘××—×¡×Ÿ!',
        '××ª ×ª××™×“ ×ª××¦××™ ×“×¨×š, ×•×¨×“, ×’× ×‘×™×•× ×”×›×™ ×¢××•×¡!',
        '×•×¨×“, ×”×™×œ×“×™× ×©×œ×š ×™×œ××“×• ×××š ××™×š ×œ×”×™×•×ª ×—×–×§×™×!',
        '×‘×¢×‘×•×“×”, ×•×¨×“, ××ª ×›××• ××œ×’×–×” â€“ ×ª××™×“ ×“×•×—×¤×ª ×§×“×™××”!',
        '×•×¨×“, ××ª ×× ×”×œ×ª ××ª ×”×‘×™×ª ×›××• ×©×¨×××™ ×× ×”×œ ××ª ×”××—×¡×Ÿ!',
        '×ª××©×™×›×™ ×œ×”×™×•×ª ××“×”×™××”, ×•×¨×“, ×‘×¢×‘×•×“×” ×•×‘×‘×™×ª!',
        '×•×¨×“, ××ª ×›××• ×¦×‘×¢ ×©××—×–×™×§ ×©× ×™× â€“ ×ª××™×“ ××•×©×œ××ª!',
        '×”×™×œ×“×™× ×©×œ×š, ×•×¨×“, ×‘×˜×— ×™×•×“×¢×™× ×©×™×© ×œ×”× ××× ×ª×•×ª×—×™×ª!'
      ];
      const prediction = `×•×¨×“, ×”×©× ×©×œ×š ×–×•×¨×— ×›××• ×¤×¨×—! ğŸŒ¹ ×ª×¨×¦×™ ×œ×“×¢×ª ××” ×¦×¤×•×™ ×œ×š? ×•×•××•, ×™×© ×›×œ ×›×š ×”×¨×‘×” ×œ×”×¨×—×™×‘! ×× ×™ ×—×•×–×” ×©×ª××©×™×›×™ ×œ×”×¤×™×¥ ××•×¨ ×‘×›×œ ××§×•×, ×•×¨×××™ ×‘×˜×•×— ×™×¡×›×™×! ğŸ˜`;
      displayBotMessage(prediction);
      for (const msg of [...motivation, ...encouragement]) {
        await addToResponses(`××•×˜×™×‘×¦×™×” ×œ×•×¨×“`, msg, ['×•×¨×“', '××•×˜×™×‘×¦×™×”'], ['×—×™×–×•×™', '×¢×™×“×•×“']);
      }
    } else if (nameData[name]) {
      const { traits, ramiThought, quip } = nameData[name];
      displayBotMessage(`×•×•××•, ${name}! ×”×©× ×©×œ×š ××•××¨: ${traits} ğŸ˜ ×¨×××™ ×—×•×©×‘: "${ramiThought}"`);
      displayBotMessage(quip);
      await addToResponses(`×—×™×–×•×™ ×œ-${name}`, `${traits} | ${ramiThought} | ${quip}`, [name, '×—×™×–×•×™'], ['×©×', '×¨×××™']);
    } else {
      displayBotMessage(`×”×©× ${name} ×××© ××’× ×™×‘! ğŸ˜ ×× ×™ ×—×•×–×” ×©×ª×”×™×” ×›×•×›×‘ ×‘××—×¡×Ÿ, ×•×¨×××™ ×‘×˜×— ××¡×›×™×!`);
      await addToResponses(`×—×™×–×•×™ ×œ-${name}`, `×›×•×›×‘ ×‘××—×¡×Ÿ!`, [name, '×—×™×–×•×™'], ['×©×', '×¨×××™']);
    }
  } catch (err) {
    console.error('Error handling name prediction:', err);
    displayBotMessage('××•×¤×¡, ×”×—×™×–×•×™ ×”×ª×‘×œ×‘×œ ×§×¦×ª... ğŸ˜… × ×¡×” ×©×•×‘!');
  }
}

// ××¦×™××ª ×ª×©×•×‘×”
function findResponse(message) {
  try {
    const messageLower = message.toLowerCase();
    for (const response of responses) {
      const keywords = response.keywords.map(k => k.toLowerCase());
      const synonyms = response.synonyms.map(s => s.toLowerCase());
      if (keywords.some(k => messageLower.includes(k)) || 
          synonyms.some(s => messageLower.includes(s)) ||
          messageLower.includes(response.question.toLowerCase())) {
        return response.answer;
      }
    }
    return '×œ× ×”×‘× ×ª×™ ××ª ×”×©××œ×”... ğŸ¤” × ×¡×” ××™×œ×•×ª ××¤×ª×— ×›××• "×‘×œ×•×§×™×", "×¦×‘×¢×™×", ××• "×”×–×× ×”"!';
  } catch (err) {
    console.error('Error finding response:', err);
    return '××•×¤×¡, ××©×”×• ×”×©×ª×‘×©... ğŸ˜… × ×¡×” ×©×•×‘!';
  }
}

// ×”×¦×’×ª ×”×•×“×¢×ª ××©×ª××©
function displayUserMessage(message) {
  try {
    const chatBody = document.getElementById('chatBody');
    if (!chatBody) throw new Error('Chat body not found');
    const messageDiv = document.createElement('div');
    messageDiv.className = 'message user-message';
    messageDiv.innerHTML = `${message}<span class="message-time">${getCurrentTime()}</span>`;
    chatBody.appendChild(messageDiv);
    chatBody.scrollTop = chatBody.scrollHeight;
    conversation.push({ type: 'user', text: message });
  } catch (err) {
    console.error('Error displaying user message:', err);
  }
}

// ×”×¦×’×ª ×”×•×“×¢×ª ×‘×•×˜
function displayBotMessage(message) {
  try {
    const chatBody = document.getElementById('chatBody');
    if (!chatBody) throw new Error('Chat body not found');
    const messageDiv = document.createElement('div');
    messageDiv.className = `message bot-message ${message.includes('×ª×¨×¦×” ×©××’×œ×”') ? 'name-prompt' : ''}`;
    messageDiv.innerHTML = `${message}<span class="message-time">${getCurrentTime()}</span>`;
    chatBody.appendChild(messageDiv);
    chatBody.scrollTop = chatBody.scrollHeight;
    conversation.push({ type: 'bot', text: message });
  } catch (err) {
    console.error('Error displaying bot message:', err);
  }
}

// ×”×¦×’×ª ××—×•×•×Ÿ ×”×§×œ×“×”
function showTypingIndicator() {
  try {
    const chatBody = document.getElementById('chatBody');
    if (!chatBody) throw new Error('Chat body not found');
    const typingDiv = document.createElement('div');
    typingDiv.className = 'typing';
    typingDiv.innerHTML = '<span></span><span></span><span></span>';
    chatBody.appendChild(typingDiv);
    chatBody.scrollTop = chatBody.scrollHeight;
  } catch (err) {
    console.error('Error showing typing indicator:', err);
  }
}

// ×”×¡×ª×¨×ª ××—×•×•×Ÿ ×”×§×œ×“×”
function hideTypingIndicator() {
  try {
    const typingDiv = document.querySelector('.typing');
    if (typingDiv) typingDiv.remove();
  } catch (err) {
    console.error('Error hiding typing indicator:', err);
  }
}

// ×–××Ÿ × ×•×›×—×™
function getCurrentTime() {
  return new Date().toLocaleTimeString('he-IL', { hour: '2-digit', minute: '2-digit' });
}

// ×¢×“×›×•×Ÿ ×›×¤×ª×•×¨×™ ××™×œ×•×ª ××¤×ª×—
function updateKeywords() {
  try {
    const keywordsContainer = document.getElementById('keywordsContainer');
    if (!keywordsContainer) throw new Error('Keywords container not found');
    keywordsContainer.innerHTML = '';
    const currentKeywords = userName ? keywords : [{ label: '×”×ª×—×œ ×©×™×—×”', question: '×”×™×™' }];
    currentKeywords.forEach((keyword, index) => {
      const btn = document.createElement('button');
      btn.className = 'keyword-btn';
      btn.style.transform = `rotate(${index * (360 / currentKeywords.length)}deg) translateX(200px) rotate(-${index * (360 / currentKeywords.length)}deg)`;
      btn.style.animationDelay = `${index * 0.2}s`;
      btn.textContent = keyword.label;
      btn.onclick = () => {
        sendMessage(keyword.question);
        btn.style.animation = 'throwEffect 0.5s ease forwards';
        setTimeout(() => updateKeywords(), 500);
        displayBotMessage('×•×•××•, ×”×›×¤×ª×•×¨ ×–×¨×— ×›××• ×”×‘×œ×•×§×™× ×©×œ ×¨×××™! âœ¨');
      };
      keywordsContainer.appendChild(btn);
    });
  } catch (err) {
    console.error('Error updating keywords:', err);
  }
}

// ×”×—×œ×¤×ª ××¡×š ××œ×
function toggleFullscreen() {
  try {
    const phoneFrame = document.getElementById('phoneFrame');
    phoneFrame.classList.toggle('fullscreen');
    document.querySelector('.fullscreen-btn').textContent = phoneFrame.classList.contains('fullscreen') ? 'ğŸ”³' : 'ğŸ”²';
  } catch (err) {
    console.error('Error toggling fullscreen:', err);
  }
}

// ×ª×¤×¨×™×˜ ×§×‘×¦×™× ××¦×•×¨×¤×™×
function toggleAttachMenu() {
  try {
    const menu = document.getElementById('attachMenu');
    menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
  } catch (err) {
    console.error('Error toggling attach menu:', err);
  }
}

// ×”×¦×’×ª ××§×œ×“×ª ×•×™×¨×˜×•××œ×™×ª
function showKeyboard() {
  try {
    const keyboard = document.getElementById('virtualKeyboard');
    keyboard.style.display = 'flex';
  } catch (err) {
    console.error('Error showing keyboard:', err);
  }
}

// ×¡×’×™×¨×ª ××§×œ×“×ª ×•×™×¨×˜×•××œ×™×ª
function closeKeyboard() {
  try {
    const keyboard = document.getElementById('virtualKeyboard');
    keyboard.style.display = 'none';
  } catch (err) {
    console.error('Error closing keyboard:', err);
  }
}

// ×”×§×œ×“×ª ×ª×•
function typeKey(char) {
  try {
    const userInput = document.getElementById('userInput');
    userInput.value += char;
    moveStylus();
  } catch (err) {
    console.error('Error typing key:', err);
  }
}

// ×ª× ×•×¢×ª ×¢×˜
function moveStylus() {
  try {
    const stylus = document.getElementById('stylus');
    const userInput = document.getElementById('userInput');
    if (userInput.value.trim()) {
      stylus.classList.add('typing');
    } else {
      stylus.classList.remove('typing');
    }
  } catch (err) {
    console.error('Error moving stylus:', err);
  }
}

// ×”×¢×œ××ª ×§×•×‘×¥
function uploadFile() {
  try {
    const fileInput = document.getElementById('fileInput');
    const file = fileInput.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = () => {
      displayBotMessage(`×§×•×‘×¥ "${file.name}" × ×©×œ×—! ğŸ“„`);
    };
    reader.readAsDataURL(file);
  } catch (err) {
    console.error('Error uploading file:', err);
    displayBotMessage('××•×¤×¡, ×œ× ×”×¦×œ×—×ª×™ ×œ×¢×œ×•×ª ××ª ×”×§×•×‘×¥... ğŸ˜…');
  }
}

// ×©×™×ª×•×£ ××™×§×•×
function shareLocation() {
  try {
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(position => {
        const { latitude, longitude } = position.coords;
        displayBotMessage(`××™×§×•× ××©×•×ª×£: ${latitude}, ${longitude} ğŸ“`);
      }, () => {
        displayBotMessage('×œ× ×”×¦×œ×—×ª×™ ×œ×§×‘×œ ××ª ×”××™×§×•×... ğŸ˜” ×•×“× ×©×”×¨×©××•×ª ×”××™×§×•× ××•×¤×¢×œ×•×ª.');
      });
    } else {
      displayBotMessage('×©×™×ª×•×£ ××™×§×•× ×œ× × ×ª××š ×‘×“×¤×“×¤×Ÿ ×–×”... ğŸ˜”');
    }
  } catch (err) {
    console.error('Error sharing location:', err);
  }
}

// ×™×¦×™×¨×ª ××™×¨×•×¢ ×‘×œ×•×— ×©× ×”
function addToCalendar() {
  try {
    displayBotMessage('××™×¨×•×¢ × ×•×¡×£ ×œ×œ×•×— ×”×©× ×” ×©×œ×š! ğŸ“…');
  } catch (err) {
    console.error('Error adding to calendar:', err);
  }
}

// ×¤×ª×™×—×ª ×˜×•×¤×¡ ×”×–×× ×”
function openOrderPopup() {
  try {
    document.getElementById('orderPopup').style.display = 'block';
    document.getElementById('overlay').style.display = 'block';
  } catch (err) {
    console.error('Error opening order popup:', err);
  }
}

// ×¡×’×™×¨×ª ×˜×•×¤×¡ ×”×–×× ×”
function closeOrderPopup() {
  try {
    document.getElementById('orderPopup').style.display = 'none';
    document.getElementById('overlay').style.display = 'none';
  } catch (err) {
    console.error('Error closing order popup:', err);
  }
}

// ×”×•×¡×¤×ª ×©×•×¨×ª ×¤×¨×™×˜
function addItemRow() {
  try {
    const tableBody = document.getElementById('itemsTableBody');
    const row = document.createElement('tr');
    row.className = 'item-row';
    row.innerHTML = `
      <td><select class="item-name" onchange="updateItemPrice(this)"></select></td>
      <td><input type="number" class="item-quantity" min="1" placeholder="×›××•×ª"></td>
      <td><input type="text" class="item-price" readonly></td>
      <td><button class="remove-item" onclick="removeItemRow(this)">Ã—</button></td>
    `;
    tableBody.appendChild(row);
    updateProductSelects();
  } catch (err) {
    console.error('Error adding item row:', err);
  }
}

// ×”×¡×¨×ª ×©×•×¨×ª ×¤×¨×™×˜
function removeItemRow(button) {
  try {
    button.closest('.item-row').remove();
  } catch (err) {
    console.error('Error removing item row:', err);
  }
}

// ×©×œ×™×—×ª ×”×–×× ×”
async function submitOrder() {
  try {
    const customer = document.getElementById('orderCustomer').value;
    const contact = document.getElementById('orderContact').value;
    const phone = document.getElementById('orderPhone').value;
    const crane = document.getElementById('orderCrane').value;
    const street = document.getElementById('orderStreet').value;
    const city = document.getElementById('orderCity').value;
    const container = document.getElementById('orderContainer').value;

    const items = Array.from(document.querySelectorAll('.item-row')).map(row => ({
      name: row.querySelector('.item-name').value,
      quantity: parseInt(row.querySelector('.item-quantity').value) || 1
    }));

    if (!customer || !contact || !phone || !items.every(item => item.name && item.quantity)) {
      displayBotMessage('×× × ××œ× ××ª ×›×œ ×”×©×“×•×ª ×‘×˜×•×¤×¡ ×”×”×–×× ×”! ğŸ“‹');
      return;
    }

    const response = await fetch(SCRIPT_URL, {
      method: 'POST',
      body: JSON.stringify({ action: 'saveOrder', data: { customer, contact, phone, crane, street, city, container, items } })
    });
    const result = await response.json();
    if (result.status !== '×”×¦×œ×—×”') throw new Error(result.message);

    displayBotMessage(`×”×”×–×× ×” × ×©×œ×—×” ×‘×”×¦×œ×—×”, ${customer}! ğŸš› ×ª×•×“×” ×©×§× ×™×ª ××¦×œ ×¨×××™!`);
    closeOrderPopup();
    await updateStats(conversation.length, document.querySelectorAll('.item-row').length);
  } catch (err) {
    console.error('Error submitting order:', err);
    displayBotMessage('××•×¤×¡, ×œ× ×”×¦×œ×—×ª×™ ×œ×©×œ×•×— ××ª ×”×”×–×× ×”... ğŸ˜… ×•×“× ×©×—×™×‘×•×¨ ×”××™× ×˜×¨× ×˜ ×ª×§×™×Ÿ ×•× ×¡×” ×©×•×‘.');
  }
}

// ×”×¦×’×ª ×¢×œ×•×ª ××›×•×œ×”
function showContainerCost() {
  try {
    const container = document.getElementById('orderContainer').value;
    const costNote = document.getElementById('containerCost');
    costNote.style.display = container !== '×œ×œ×' ? 'block' : 'none';
  } catch (err) {
    console.error('Error showing container cost:', err);
  }
}

// ×¤×ª×™×—×ª ×—×œ×•× ×™×ª "××™×š ×× ×™ ×¢×•×‘×“"
function openHowToPopup() {
  try {
    document.getElementById('howToPopup').style.display = 'block';
    document.getElementById('overlay').style.display = 'block';
  } catch (err) {
    console.error('Error opening how-to popup:', err);
  }
}

// ×¡×’×™×¨×ª ×—×œ×•× ×™×ª "××™×š ×× ×™ ×¢×•×‘×“"
function closeHowToPopup() {
  try {
    document.getElementById('howToPopup').style.display = 'none';
    document.getElementById('overlay').style.display = 'none';
  } catch (err) {
    console.error('Error closing how-to popup:', err);
  }
}

// ×˜×¢×™× ×ª ×”×“×£
window.onload = () => {
  try {
    preloadImages();
    fetchResponses();
    fetchProducts();
    updateKeywords();
    displayBotMessage('<span class="welcome-message">×‘×¨×•×š ×”×‘× ×œ×—.×¡×‘×Ÿ ×—×•××¨×™ ×‘× ×™×™×Ÿ, ×”×ª×œ××™×“ 6, ×”×•×“ ×”×©×¨×•×Ÿ! ğŸ—ï¸ ××™×š ×§×•×¨××™× ×œ×š? ğŸ˜</span>');
    setTimeout(() => {
      const input = document.getElementById('userInput');
      if (input) {
        input.classList.add('guide');
        setTimeout(() => input.classList.remove('guide'), 6000);
      }
    }, 2000);
  } catch (err) {
    console.error('Error on load:', err);
    displayBotMessage('××•×¤×¡, ××©×”×• ×”×©×ª×‘×© ×‘×˜×¢×™× ×ª ×”×“×£... ğŸ˜… ×•×“× ×©×—×™×‘×•×¨ ×”××™× ×˜×¨× ×˜ ×ª×§×™×Ÿ ×•× ×¡×” ×©×•×‘.');
  }
};

    let userName = '';
    let userPhone = '';
    let conversation = [];

    // ×××’×¨ ×ª×•×›×Ÿ ××•×‘× ×” - ×”×—×–×¨×ª ×”×“×•-×©×™×— ×”××œ×
    const responses = [
      { question: '××” ×©×¢×•×ª ×”×¤×ª×™×—×”?', answer: '×¤×ª×•×—×™× ×-06:00 ×¢×“ 18:00, ×¨××©×•×Ÿ-×—××™×©×™, ×©×™×©×™ ×¢×“ 13:00, ×”×ª×œ××™×“ 6, ×”×•×“ ×”×©×¨×•×Ÿ. ×ª×’×™×¢ ×•×ª×¨××” ××™×š ×¨×××™ ×©×•×œ×˜! â˜•', keywords: ['×©×¢×•×ª', '×¤×ª×™×—×”', '×–×× ×™×'], synonyms: ['×¤×¢×™×œ×•×ª', '×¢×‘×•×“×”', '××ª×™'] },
      { question: '×™×© ×œ×›× ×‘×œ×•×§×™×?', answer: '×‘×œ×•×§×™×? ×˜×•× ×•×ª ×©×œ ××™×›×•×ª! ğŸ§± ×ª×’×™×“ ×›××”, ×•××‘×“×•×§ ××—×™×¨ ×¢× ×¨×××™. <img src="https://i.postimg.cc/3J9Y4b0Z/blocks.jpg" class="message-image" onerror="this.src=\'https://via.placeholder.com/250\';"> ×¨×•×¦×” ××—×©×‘×•×Ÿ? ğŸ“ <a href="#" onclick="showCalculator(\'blocks\')">×—×©×‘ ×¢×›×©×™×•</a>', keywords: ['×‘×œ×•×§×™×', '×œ×‘× ×™×', '××‘× ×™×'], synonyms: ['×—×•××¨×™ ×‘× ×™×™×”', '×§×™×¨×•×ª'] },
      { question: '××¤×©×¨ ×œ×”×–××™×Ÿ ××›×•×œ×”?', answer: '××›×•×œ×”? ×‘×›×™×£! ğŸš› ×”×¦×‘×”, ×”×—×œ×¤×”, ××• ×”×•×¦××”? ×¢×œ×•×ª ×”×¦×‘×”/×”×—×œ×¤×”: 1416 ×©"×— ×›×•×œ×œ ××¢"×. <a href="#" onclick="openOrderPopup()">×¤×ª×— ×”×–×× ×”</a> ××• ×©××©××œ ××•×ª×š ×œ×˜×•×¤×¡ ×™×•×§×¨×ª×™? ğŸ˜', keywords: ['××›×•×œ×”', '×§×•× ×˜×™×™× ×¨', '××©×œ×•×—'], synonyms: ['×”×•×‘×œ×”', '×¤×¡×•×œ×ª'] },
      { question: '××™ ×–×” ×¨×××™?', answer: '×¨×××™ ×”×•× ×”××’×“×” ×©×œ ×—.×¡×‘×Ÿ! ğŸ˜ ××œ×š ×”×‘×œ×•×§×™× ×•×”×—×™×•×›×™×. ×©×œ×— ×œ×• ×•×•××˜×¡××¤? ğŸ“²', keywords: ['×¨×××™', '×× ×”×œ', '×‘×¢×œ×™×'], synonyms: ['×”×‘×•×¡', '××—×¨××™'] },
      { question: '××¤×©×¨ ×”× ×—×”?', answer: '×”× ×—×”? ×ª×‘×™× ×—×™×•×š ×•××¨××” ××” ××¤×©×¨ ×œ×¢×©×•×ª! ğŸ˜„ ××‘×¦×¢: 10% ×¢×œ ×¦×‘×¢×™ ×˜××‘×•×¨! ×¨××™×ª ××™×š ×”×›×¤×ª×•×¨ ×–×¨×—? âœ¨', keywords: ['×”× ×—×”', '××—×™×¨', '××‘×¦×¢'], synonyms: ['×–×•×œ', '×”×˜×‘×”'] },
      { question: '×¦×‘×¢×™×?', answer: '×¦×‘×¢×™× ×©×œ ×˜××‘×•×¨, × ×™×¨×œ×˜, ×™×¢×§×•×‘×™! ğŸ¨ ×ª×’×™×“ ×’×•×•×Ÿ ×•×’×•×“×œ, ×•××©×œ×— ×œ×¨×××™. <img src="https://i.postimg.cc/5y3t8QzT/paint.jpg" class="message-image" onerror="this.src=\'https://via.placeholder.com/250\';"> ××—×©×‘×•×Ÿ ×¦×‘×¢? <a href="#" onclick="showCalculator(\'paint\')">×—×©×‘ ×›××•×ª</a>', keywords: ['×¦×‘×¢×™×', '×¦×‘×¢', '×’×•×•×Ÿ'], synonyms: ['×œ×§×•×ª', '××©×˜×—×™×'] },
      { question: '×›×œ×™ ×¢×‘×•×“×”?', answer: '×‘×•×©, ××§×™×˜×”, ×©×˜×œ â€“ ×”×›×œ ×›××Ÿ! ğŸ”§ ××‘×¦×¢: 15% ×¢×œ ××§×“×—×•×ª ×‘×•×©! <img src="https://i.postimg.cc/4yqP2R9Z/tools.jpg" class="message-image" onerror="this.src=\'https://via.placeholder.com/250\';">', keywords: ['×›×œ×™ ×¢×‘×•×“×”', '×¦×™×•×“', '××§×“×—×”'], synonyms: ['×›×œ×™×', '××›×©×™×¨×™×'] },
      { question: '×—×•×œ?', answer: '×—×•×œ? ×™×•×ª×¨ ×˜×•× ×•×ª ×××“×‘×¨ ×¡×”×¨×”! ğŸ–ï¸ ×ª×’×™×“ ×›××”, ×•××›×™×Ÿ ×˜×•×¤×¡ ×™×•×§×¨×ª×™! ğŸ˜ <a href="#" onclick="openOrderPopup()">×¤×ª×— ×”×–×× ×”</a>', keywords: ['×—×•×œ', '××—×™×¨'], synonyms: ['×—×•××¨×™×', '×¢×œ×•×ª'] },
      { question: '××™×§×•×?', answer: '×”×ª×œ××™×“ 6, ×”×•×“ ×”×©×¨×•×Ÿ, ×××© ×œ×™×“ ×›×‘×™×© 55! ğŸ—ºï¸ ×¤×ª×•×—×™× ×-06:00 ×¢×“ 18:00, ×¨××©×•×Ÿ-×—××™×©×™.', keywords: ['××™×§×•×', '×›×ª×•×‘×ª', '××™×¤×”'], synonyms: ['××§×•×', '×”×’×¢×”'] },
      { question: '××‘×¦×¢×™×?', answer: '××‘×¦×¢×™× ××©×’×¢×™×! 10% ×¢×œ ×˜××‘×•×¨, 15% ×¢×œ ××§×“×—×•×ª ×‘×•×©! ğŸ‰ ×ª×’×™×“ ××” ×‘× ×œ×š!', keywords: ['××‘×¦×¢×™×', '×”× ×—×”', '××‘×¦×¢'], synonyms: ['×”×˜×‘×•×ª', '×–×•×œ'] }
    ];

    const randomResponses = [
      '×•×•××•, ×©××œ×” ×›×‘×“×” ×›××• ××©××™×ª ××œ×˜! ğŸ¤¯ ×ª×¤×¨×˜ ×§×¦×ª?',
      '×œ× ×ª×¤×¡×ª×™, ××‘×œ ×¨×××™ ×™×•×“×¢ ×”×›×œ! ğŸ“² ×©×œ×— ×œ×• ×•×•××˜×¡××¤?',
      '×©××œ×” ×›××• ×‘×œ×•×§ ×¢×§×©×Ÿ! ğŸ˜… ×ª× ×¡×” ×©×•×‘?',
      '×¦×¨×™×š ×§×¦×ª ×¦×‘×¢ ×¢×œ ×”×©××œ×” ×”×–×•! ğŸ¨ ×ª×’×™×“ ×¢×•×“?'
    ];

    const keywords = [
      { label: '×©×¢×•×ª ×¤×ª×™×—×”', question: '××” ×©×¢×•×ª ×”×¤×ª×™×—×”?' },
      { label: '×‘×œ×•×§×™×', question: '×™×© ×œ×›× ×‘×œ×•×§×™×?' },
      { label: '××›×•×œ×”', question: '××¤×©×¨ ×œ×”×–××™×Ÿ ××›×•×œ×”?' },
      { label: '×”× ×—×”', question: '××¤×©×¨ ×”× ×—×”?' },
      { label: '××™ ×–×” ×¨×××™?', question: '××™ ×–×” ×¨×××™?' },
      { label: '×¦×‘×¢×™×', question: '×¦×‘×¢×™×?' },
      { label: '×›×œ×™ ×¢×‘×•×“×”', question: '×›×œ×™ ×¢×‘×•×“×”?' },
      { label: '×—×•×œ', question: '×—×•×œ?' },
      { label: '××™×§×•×', question: '××™×§×•×?' },
      { label: '××‘×¦×¢×™×', question: '××‘×¦×¢×™×?' }
    ];

    // ×‘×“×™×§×ª ×˜×¢×™× ×ª ×ª××•× ×•×ª
    function preloadImages() {
      const images = [
        'https://i.postimg.cc/t4Q91FDQ/Screenshot-20250427-160448-Whats-App-Business.jpg',
        'https://i.postimg.cc/3J9Y4b0Z/blocks.jpg',
        'https://i.postimg.cc/5y3t8QzT/paint.jpg',
        'https://i.postimg.cc/4yqP2R9Z/tools.jpg',
        'https://theverifier.co.il/wp-content/uploads/2019/02/whatsapp-promo-1024x538.png'
      ];
      images.forEach(src => {
        const img = new Image();
        img.src = src;
        img.onerror = () => { img.src = 'https://via.placeholder.com/250'; };
      });
    }

    // ×¢×“×›×•×Ÿ ×–××Ÿ ×”×•×“×¢×•×ª
    function updateMessageTimes() {
      document.querySelectorAll('.message-time').forEach(span => {
        span.textContent = new Date().toLocaleTimeString('he-IL', { hour: '2-digit', minute: '2-digit' });
      });
    }

    window.onload = () => {
      try {
        preloadImages();
        updateKeywords();
        updateMessageTimes();
      } catch (err) {
        console.error('Error on load:', err);
      }
    };

    function toggleFullscreen() {
      try {
        const tabletFrame = document.getElementById('tabletFrame');
        tabletFrame.classList.toggle('fullscreen');
        document.querySelector('.fullscreen-btn').textContent = tabletFrame.classList.contains('fullscreen') ? 'ğŸ”³' : 'ğŸ”²';
      } catch (err) {
        console.error('Error toggling fullscreen:', err);
      }
    }

    function toggleAttachMenu() {
      try {
        const menu = document.getElementById('attachMenu');
        menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
      } catch (err) {
        console.error('Error toggling attach menu:', err);
      }
    }

    function updateKeywords() {
      try {
        const keywordsContainer = document.getElementById('keywordsContainer');
        keywordsContainer.innerHTML = '';
        const currentKeywords = userName ? keywords : [{ label: '×”×ª×—×œ ×©×™×—×”', question: '×”×™×™' }];
        currentKeywords.forEach((keyword, index) => {
          const btn = document.createElement('button');
          btn.className = 'keyword-btn';
          btn.style.transform = `rotate(${index * (360 / currentKeywords.length)}deg) translateX(400px) rotate(-${index * (360 / currentKeywords.length)}deg)`;
          btn.style.animationDelay = `${index * 0.2}s`;
          btn.textContent = keyword.label;
          btn.onclick = () => {
            sendMessage(keyword.question);
            btn.style.animation = 'throwEffect 0.5s ease forwards';
            setTimeout(() => updateKeywords(), 500);
            displayBotMessage(`×•×•××•, ×”×›×¤×ª×•×¨ ×–×¨×— ×›××• ×”×‘×œ×•×§×™× ×©×œ ×¨×××™! âœ¨`);
          };
          keywordsContainer.appendChild(btn);
        });
      } catch (err) {
        console.error('Error updating keywords:', err);
      }
    }

    function openOrderPopup() {
      try {
        document.getElementById('orderPopup').style.display = 'block';
        document.getElementById('overlay').style.display = 'block';
        document.getElementById('orderCustomer').value = userName || '';
        document.getElementById('orderPhone').value = userPhone || '';
      } catch (err) {
        console.error('Error opening order popup:', err);
      }
    }

    function closeOrderPopup() {
      try {
        const popup = document.getElementById('orderPopup');
        popup.style.animation = 'fadeOut 0.3s ease forwards';
        setTimeout(() => {
          popup.style.display = 'none';
          document.getElementById('overlay').style.display = 'none';
          popup.style.animation = '';
        }, 300);
      } catch (err) {
        console.error('Error closing order popup:', err);
      }
    }

    function showContainerCost() {
      try {
        const container = document.getElementById('orderContainer').value;
        const costNote = document.getElementById('containerCost');
        costNote.style.display = container === '×”×¦×‘×ª ××›×•×œ×”' || container === '×”×—×œ×¤×ª ××›×•×œ×”' ? 'inline' : 'none';
      } catch (err) {
        console.error('Error showing container cost:', err);
      }
    }

    function addItemRow() {
      try {
        const itemsList = document.querySelector('.items-list');
        const row = document.createElement('div');
        row.className = 'item-row';
        row.innerHTML = `
          <input type="text" placeholder="×¤×¨×™×˜, ×œ××©×œ: ×‘×œ×•×§×™×" class="item-name">
          <input type="number" placeholder="×›××•×ª" class="item-quantity">
          <button class="remove-item" onclick="removeItemRow(this)">Ã—</button>
        `;
        itemsList.appendChild(row);
        row.style.animation = 'slideIn 0.3s ease';
      } catch (err) {
        console.error('Error adding item row:', err);
      }
    }

    function removeItemRow(btn) {
      try {
        const row = btn.parentElement;
        row.style.animation = 'fadeOut 0.3s ease forwards';
        setTimeout(() => row.remove(), 300);
      } catch (err) {
        console.error('Error removing item row:', err);
      }
    }

    async function submitOrder() {
      try {
        const customer = document.getElementById('orderCustomer').value;
        const contact = document.getElementById('orderContact').value;
        const phone = document.getElementById('orderPhone').value;
        const crane = document.getElementById('orderCrane').value;
        const street = document.getElementById('orderStreet').value;
        const city = document.getElementById('orderCity').value;
        const container = document.getElementById('orderContainer').value;
        const items = Array.from(document.querySelectorAll('.item-row')).map(row => ({
          name: row.querySelector('.item-name').value,
          quantity: row.querySelector('.item-quantity').value
        }));

        if (!customer || !contact || !phone || !street || !city || items.length === 0 || !items[0].name || !items[0].quantity) {
          displayBotMessage('××•×¤×¡, ×ª××œ× ××ª ×›×œ ×”×©×“×•×ª ×›×“×™ ×©× ×¨×™×¥ ××ª ×”×”×–×× ×”! ğŸ˜Š');
          return;
        }

        const orderData = { customer, contact, phone, crane, street, city, container, items };
        closeOrderPopup();
        displayBotMessage(`×”×–×× ×” × ×©×œ×—×” ×œ×¨×××™ ×‘×™×•×§×¨×”! ğŸ“¦ ×¤×¨×˜×™×:\n${JSON.stringify(orderData, null, 2)}`);
        sendOrderToWhatsApp(orderData);
      } catch (err) {
        console.error('Error submitting order:', err);
        displayBotMessage('××•×¤×¡, ××©×”×• ×”×©×ª×‘×©... ğŸ˜… × ×¡×” ×©×•×‘.');
      }
    }

    async function sendMessage(inputMessage) {
      try {
        const chatBody = document.getElementById('chatBody');
        const userInput = document.getElementById('userInput');
        const message = inputMessage || userInput.value.trim();
        if (!message) return;

        const userMsg = document.createElement('div');
        userMsg.className = 'message user-message';
        userMsg.innerHTML = `${message}<span class="message-time"></span>`;
        chatBody.appendChild(userMsg);
        chatBody.scrollTop = chatBody.scrollHeight;
        conversation.push({ question: message, answer: '' });
        userInput.value = '';

        const typing = document.createElement('div');
        typing.className = 'typing';
        typing.innerHTML = '<span></span><span></span><span></span>';
        chatBody.appendChild(typing);
        chatBody.scrollTop = chatBody.scrollHeight;

        await new Promise(resolve => setTimeout(resolve, 1000));

        const normalizedMessage = message.toLowerCase();
        if (!userName && normalizedMessage !== '×”×™×™') {
          userName = message;
          displayBotMessage(`× ×¢×™× ×××•×“, ${userName}! ğŸ˜ ××” ××¤×©×¨ ×œ×¢×©×•×ª ×‘×©×‘×™×œ×š?`);
          updateKeywords();
        } else {
          const response = responses.find(r =>
            r.keywords.some(k => normalizedMessage.includes(k.toLowerCase())) ||
            r.synonyms.some(s => normalizedMessage.includes(s.toLowerCase()))
          );

          if (response) {
            displayBotMessage(response.answer);
            conversation[conversation.length - 1].answer = response.answer;
          } else {
            const randomResponse = randomResponses[Math.floor(Math.random() * randomResponses.length)];
            displayBotMessage(randomResponse);
            conversation[conversation.length - 1].answer = randomResponse;
          }
        }

        chatBody.removeChild(typing);
        updateMessageTimes();
      } catch (err) {
        console.error('Error sending message:', err);
        displayBotMessage('××•×¤×¡, ××©×”×• ×”×©×ª×‘×©... ğŸ˜… × ×¡×” ×©×•×‘.');
      }
    }

    async function uploadFile() {
      try {
        const fileInput = document.getElementById('fileInput');
        const file = fileInput.files[0];
        if (!file) {
          displayBotMessage('×œ× ×‘×—×¨×ª ×§×•×‘×¥! ğŸ“‚ × ×¡×” ×©×•×‘.');
          return;
        }

        const progress = document.getElementById('uploadProgress');
        progress.style.display = 'block';

        await new Promise(resolve => setTimeout(resolve, 2000));
        displayBotMessage(`×§×•×‘×¥ ${file.name} ×”×•×¢×œ×” ×‘×¡×˜×™×™×œ! ğŸ“ × ×©×œ×— ×œ×¨×××™.`);
        sendFileToWhatsApp(file.name);

        progress.style.display = 'none';
        fileInput.value = '';
      } catch (err) {
        console.error('Error uploading file:', err);
        displayBotMessage('××•×¤×¡, ×”×”×¢×œ××” ×œ× ×”×¦×œ×™×—×”... ğŸ˜• × ×¡×” ×©×•×‘.');
      }
    }

    function shareLocation() {
      try {
        displayBotMessage('××™×§×•× × ×©×œ×—! ğŸ“ ××¢×‘×™×¨ ×œ×¨×××™ ×‘×™×•×§×¨×”.');
        sendToWhatsApp('××™×§×•×: ×”×ª×œ××™×“ 6, ×”×•×“ ×”×©×¨×•×Ÿ');
      } catch (err) {
        console.error('Error sharing location:', err);
      }
    }

    function addToCalendar() {
      try {
        displayBotMessage('×ª×–×›×•×¨×ª × ×•×¡×¤×” ×œ×™×•××Ÿ! ğŸ“… ×ª×’×™×¢ ×œ×ª×œ××™×“ 6 ×‘×¡×˜×™×™×œ!');
      } catch (err) {
        console.error('Error adding to calendar:', err);
      }
    }

    function showCalculator(type) {
      try {
        displayBotMessage(`××—×©×‘×•×Ÿ ${type === 'blocks' ? '×‘×œ×•×§×™×' : '×¦×‘×¢'} ×™×•×§×¨×ª×™ ×™×™×¤×ª×— ×‘×§×¨×•×‘! ğŸ“ ×¤×•× ×§×¦×™×” ×‘×‘× ×™×™×”.`);
      } catch (err) {
        console.error('Error showing calculator:', err);
      }
    }

    function sendToWhatsApp(message) {
      try {
        const msg = encodeURIComponent(message);
        const url = `https://wa.me/972508860896?text=${msg}`;
        window.open(url, '_blank');
      } catch (err) {
        console.error('Error sending to WhatsApp:', err);
      }
    }

    function sendOrderToWhatsApp(order) {
      try {
        const message = `ğŸ“¦ ×”×–×× ×” ×™×•×§×¨×ª×™×ª!\n×©×: ${order.customer}\n××™×© ×§×©×¨: ${order.contact}\n× ×™×™×“: ${order.phone}\n×›×ª×•×‘×ª: ${order.street}, ${order.city}\n×× ×•×£: ${order.crane}\n××›×•×œ×”: ${order.container}${order.container.includes('×”×¦×‘×”') || order.container.includes('×”×—×œ×¤×”') ? ' (1416 ×©"×—)' : ''}\n×¤×¨×™×˜×™×:\n${order.items.map((item, i) => `${i + 1}. ${item.name} - ${item.quantity} ×™×—×™×“×•×ª`).join('\n')}`;
        sendToWhatsApp(message);
      } catch (err) {
        console.error('Error sending order to WhatsApp:', err);
      }
    }

    function sendFileToWhatsApp(fileName) {
      try {
        const message = `ğŸ“ ×§×•×‘×¥ ×™×•×§×¨×ª×™!\n×©×: ${userName}\n×§×•×‘×¥: ${fileName}`;
        sendToWhatsApp(message);
      } catch (err) {
        console.error('Error sending file to WhatsApp:', err);
      }
    }

    function displayBotMessage(message) {
      try {
        const chatBody = document.getElementById('chatBody');
        const botMsg = document.createElement('div');
        botMsg.className = 'message bot-message';
        botMsg.innerHTML = `${message}<span class="message-time"></span>`;
        chatBody.appendChild(botMsg);
        chatBody.scrollTop = chatBody.scrollHeight;
        updateMessageTimes();
      } catch (err) {
        console.error('Error displaying bot message:', err);
      }
    }
  </script>
</body>
</html>

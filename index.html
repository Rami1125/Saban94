<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>צ'אט הוואטסאפ של ראמי - ח.סבן חומרי בניין</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #1a1a1a, #2c2c2c);
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      overflow: hidden;
    }
    .keywords-container {
      position: absolute;
      width: 900px;
      height: 900px;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      pointer-events: none;
    }
    .keyword-btn {
      position: absolute;
      padding: 14px 28px;
      background: linear-gradient(145deg, #25d366, #128c7e);
      color: white;
      border: none;
      border-radius: 30px;
      cursor: pointer;
      font-size: 16px;
      font-weight: bold;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      pointer-events: auto;
      animation: rotate360 20s linear infinite, pulse 2s ease-in-out infinite;
    }
    .keyword-btn:hover {
      transform: scale(1.15) translateY(-10px);
      box-shadow: 0 8px 30px rgba(37,211,102,0.6);
      animation-play-state: paused;
    }
    .keyword-btn:active {
      animation: throwEffect 0.5s ease forwards;
    }
    @keyframes rotate360 {
      0% { transform: rotate(0deg) translateX(400px) rotate(0deg); }
      100% { transform: rotate(360deg) translateX(400px) rotate(-360deg); }
    }
    @keyframes throwEffect {
      0% { transform: scale(1) translate(0, 0); opacity: 1; }
      50% { transform: scale(1.3) translate(80px, -80px); opacity: 0.6; }
      100% { transform: scale(0.7) translate(160px, -160px); opacity: 0; }
    }
    @keyframes pulse {
      0% { transform: scale(1); box-shadow: 0 4px 20px rgba(37,211,102,0.3); }
      50% { transform: scale(1.06); box-shadow: 0 8px 30px rgba(37,211,102,0.5); }
      100% { transform: scale(1); box-shadow: 0 4px 20px rgba(37,211,102,0.3); }
    }
    .tablet-frame {
      width: 768px;
      height: 1024px;
      background: linear-gradient(145deg, #2c2c2c, #1a1a1a);
      border-radius: 40px;
      padding: 30px;
      box-shadow: 0 30px 80px rgba(0,0,0,0.7);
      position: relative;
      z-index: 10;
      transition: transform 0.3s ease;
    }
    .tablet-frame.fullscreen {
      width: 100%;
      height: 100vh;
      border-radius: 0;
      padding: 0;
    }
    .tablet-notch {
      width: 200px;
      height: 30px;
      background: #1a1a1a;
      border-radius: 0 0 30px 30px;
      position: absolute;
      top: 15px;
      left: 50%;
      transform: translateX(-50%);
    }
    .fullscreen-btn {
      position: absolute;
      top: 20px;
      right: 20px;
      background: linear-gradient(145deg, #25d366, #128c7e);
      color: white;
      border: none;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      font-size: 20px;
      cursor: pointer;
      box-shadow: 0 4px 15px rgba(0,0,0,0.3);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .fullscreen-btn:hover {
      transform: scale(1.15);
      box-shadow: 0 8px 25px rgba(37,211,102,0.6);
    }
    .chat-container {
      width: 100%;
      height: 100%;
      background-color: #fff;
      border-radius: 30px;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      box-shadow: inset 0 0 15px rgba(0,0,0,0.1);
    }
    .chat-header {
      background: linear-gradient(145deg, #075e54, #128c7e);
      color: white;
      padding: 20px;
      display: flex;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 10;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    .chat-header img {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      margin-left: 15px;
      border: 3px solid #fff;
      transition: transform 0.3s ease;
    }
    .chat-header img:hover {
      transform: scale(1.15) rotate(12deg);
    }
    .chat-header h3 {
      margin: 0;
      font-size: 20px;
      font-weight: 600;
    }
    .chat-header .status {
      display: flex;
      align-items: center;
      margin: 0;
      font-size: 14px;
      opacity: 0.85;
    }
    .chat-header .status-dot {
      width: 12px;
      height: 12px;
      background-color: #25d366;
      border-radius: 50%;
      margin-left: 8px;
      animation: glow 1.5s ease-in-out infinite;
    }
    @keyframes glow {
      0% { box-shadow: 0 0 8px #25d366; }
      50% { box-shadow: 0 0 20px #25d366; }
      100% { box-shadow: 0 0 8px #25d366; }
    }
    .chat-body {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
      background: url('https://theverifier.co.il/wp-content/uploads/2019/02/whatsapp-promo-1024x538.png') repeat;
      background-size: cover;
      background-color: rgba(255,255,255,0.9);
      scroll-behavior: smooth;
    }
    .message {
      margin: 12px 0;
      padding: 14px 20px;
      border-radius: 14px;
      max-width: 75%;
      position: relative;
      animation: slideIn 0.3s ease-out;
      word-wrap: break-word;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
      transition: transform 0.2s ease;
    }
    .message:hover {
      transform: scale(1.03);
    }
    .user-message {
      background: linear-gradient(145deg, #dcf8c6, #b3e0a3);
      align-self: flex-end;
      margin-left: 15px;
      border-bottom-right-radius: 4px;
    }
    .bot-message {
      background: linear-gradient(145deg, #ffffff, #f0f0f0);
      align-self: flex-start;
      margin-right: 15px;
      border-bottom-left-radius: 4px;
    }
    .message-time {
      font-size: 12px;
      color: #666;
      position: absolute;
      bottom: 8px;
      left: 14px;
      opacity: 0.75;
    }
    .message-image {
      max-width: 250px;
      border-radius: 14px;
      border: 3px solid #075e54;
      margin-top: 8px;
      transition: transform 0.2s ease;
    }
    .message-image:hover {
      transform: scale(1.06);
    }
    .chat-footer {
      display: flex;
      padding: 15px;
      background: linear-gradient(145deg, #f0f0f0, #e0e0e0);
      border-top: 1px solid #ddd;
      position: relative;
      align-items: center;
    }
    .chat-footer input {
      flex: 1;
      padding: 16px 28px;
      border: none;
      border-radius: 30px;
      background: #fff;
      box-shadow: 0 4px 15px rgba(0,0,0,0.15);
      font-size: 16px;
      max-width: 65%;
      transition: box-shadow 0.2s ease, transform 0.2s ease;
    }
    .chat-footer input:focus {
      box-shadow: 0 4px 20px rgba(37,211,102,0.4);
      transform: scale(1.02);
      outline: none;
    }
    .chat-footer button {
      padding: 16px;
      border: none;
      background: linear-gradient(145deg, #25d366, #128c7e);
      color: white;
      border-radius: 50%;
      cursor: pointer;
      margin-right: 15px;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }
    .chat-footer button:hover {
      transform: scale(1.15);
      box-shadow: 0 8px 25px rgba(37,211,102,0.6);
    }
    .attach-btn {
      background: none;
      color: #075e54;
      font-size: 24px;
      margin-right: 15px;
    }
    .attach-menu {
      display: none;
      position: absolute;
      bottom: 80px;
      right: 15px;
      background: #fff;
      border-radius: 20px;
      box-shadow: 0 8px 30px rgba(0,0,0,0.3);
      padding: 15px;
      animation: slideDown 0.3s ease;
      z-index: 10;
    }
    .attach-menu button {
      display: block;
      width: 100%;
      padding: 14px;
      background: none;
      border: none;
      text-align: right;
      color: #075e54;
      cursor: pointer;
      font-size: 16px;
      transition: background 0.2s ease;
    }
    .attach-menu button:hover {
      background: #f0f0f0;
      border-radius: 12px;
    }
    .file-upload {
      display: none;
      position: relative;
    }
    .file-upload input {
      display: none;
    }
    .upload-progress {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 70px;
      height: 70px;
      border: 8px solid #f0f0f0;
      border-top: 8px solid #25d366;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      display: none;
    }
    @keyframes spin {
      0% { transform: translate(-50%, -50%) rotate(0deg); }
      100% { transform: translate(-50%, -50%) rotate(360deg); }
    }
    .typing {
      display: flex;
      align-items: center;
      padding: 14px;
      background: #fff;
      border-radius: 14px;
      margin: 12px 15px;
      max-width: 75%;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }
    .typing span {
      width: 12px;
      height: 12px;
      background: linear-gradient(145deg, #25d366, #128c7e);
      border-radius: 50%;
      margin: 0 5px;
      animation: bounce 0.6s infinite alternate, fade 0.6s infinite alternate;
    }
    .typing span:nth-child(2) {
      animation-delay: 0.2s;
    }
    .typing span:nth-child(3) {
      animation-delay: 0.4s;
    }
    @keyframes bounce {
      from { transform: translateY(0); }
      to { transform: translateY(-8px); }
    }
    @keyframes fade {
      from { opacity: 1; }
      to { opacity: 0.4; }
    }
    .order-popup {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(0.8);
      background: linear-gradient(145deg, #ffffff, #f5f5f5);
      padding: 40px;
      border-radius: 30px;
      box-shadow: 0 15px 50px rgba(0,0,0,0.5);
      z-index: 100;
      width: 600px;
      max-height: 90vh;
      overflow-y: auto;
      animation: zoomIn 0.3s ease forwards;
      border: 1px solid rgba(37,211,102,0.2);
    }
    .order-popup h3 {
      margin: 0 0 30px;
      color: #075e54;
      text-align: center;
      font-size: 24px;
      font-weight: 600;
      text-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .order-popup label {
      display: block;
      margin: 20px 0 8px;
      font-size: 16px;
      color: #333;
      font-weight: 500;
    }
    .order-popup input, .order-popup select {
      width: 100%;
      padding: 14px;
      border: 1px solid #ddd;
      border-radius: 14px;
      font-size: 16px;
      background: #fff;
      box-shadow: inset 0 1px 4px rgba(0,0,0,0.1);
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }
    .order-popup input:focus, .order-popup select:focus {
      border-color: #25d366;
      box-shadow: 0 0 15px rgba(37,211,102,0.4);
      outline: none;
    }
    .order-popup .corrected {
      color: #25d366;
      background: #25d36611;
      animation: highlight 0.5s ease;
    }
    @keyframes highlight {
      0% { background: #25d36633; }
      100% { background: #25d36611; }
    }
    .order-popup .cost-note {
      font-size: 14px;
      color: #ff4444;
      margin-right: 15px;
      animation: fadeIn 0.5s ease;
      display: inline-block;
    }
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    .order-popup .items-list {
      margin-top: 30px;
      background: #f9f9f9;
      padding: 20px;
      border-radius: 14px;
    }
    .order-popup .item-row {
      display: flex;
      align-items: center;
      margin-bottom: 20px;
      animation: slideIn 0.3s ease;
    }
    .order-popup .item-row input {
      width: 60%;
      margin-left: 15px;
    }
    .order-popup .item-row input[type="number"] {
      width: 30%;
    }
    .order-popup .remove-item {
      background: #ff4444;
      color: white;
      border: none;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      transition: transform 0.2s ease;
    }
    .order-popup .remove-item:hover {
      transform: scale(1.15);
    }
    .order-popup button {
      width: 100%;
      padding: 16px;
      background: linear-gradient(145deg, #25d366, #128c7e);
      color: white;
      border: none;
      border-radius: 20px;
      cursor: pointer;
      margin-top: 20px;
      font-size: 18px;
      font-weight: 600;
      box-shadow: 0 4px 20px rgba(0,0,0,0.2);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .order-popup button:hover {
      transform: scale(1.05);
      box-shadow: 0 8px 30px rgba(37,211,102,0.5);
    }
    .order-popup .close-btn {
      background: linear-gradient(145deg, #ff6666, #cc0000);
    }
    .order-popup .close-btn:hover {
      box-shadow: 0 8px 30px rgba(255,102,102,0.5);
    }
    .overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.6);
      z-index: 99;
      backdrop-filter: blur(4px);
    }
    @keyframes slideIn {
      from { transform: translateX(30px); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    @keyframes slideDown {
      from { transform: translateY(-30px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    @keyframes zoomIn {
      from { transform: translate(-50%, -50%) scale(0.8); opacity: 0; }
      to { transform: translate(-50%, -50%) scale(1); opacity: 1; }
    }
    @keyframes fadeOut {
      from { opacity: 1; }
      to { opacity: 0; }
    }
    @media (max-width: 800px) {
      .tablet-frame {
        width: 100%;
        height: 100vh;
        border-radius: 0;
        padding: 0;
      }
      .tablet-notch, .fullscreen-btn {
        display: none;
      }
      .chat-container {
        border-radius: 0;
      }
      .keywords-container {
        width: 100%;
        height: auto;
        top: auto;
        bottom: 30px;
        transform: none;
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 15px;
      }
      .keyword-btn {
        position: static;
        animation: none;
        transform: none;
        padding: 12px 24px;
        font-size: 14px;
      }
      .order-popup {
        width: 95%;
        padding: 20px;
      }
      .chat-footer input {
        max-width: 60%;
        padding: 12px 20px;
        font-size: 14px;
      }
      .chat-footer button {
        padding: 12px;
        margin-right: 10px;
      }
      .chat-header img {
        width: 40px;
        height: 40px;
        margin-left: 10px;
      }
      .chat-header h3 {
        font-size: 18px;
      }
      .message {
        max-width: 80%;
        padding: 12px 16px;
        font-size: 14px;
      }
      .message-image {
        max-width: 200px;
      }
    }
  </style>
</head>
<body>
  <div class="keywords-container" id="keywordsContainer"></div>
  <div class="tablet-frame" id="tabletFrame">
    <div class="tablet-notch"></div>
    <button class="fullscreen-btn" onclick="toggleFullscreen()">🔲</button>
    <div class="chat-container">
      <div class="chat-header">
        <img src="https://i.postimg.cc/t4Q91FDQ/Screenshot-20250427-160448-Whats-App-Business.jpg" alt="ראמי" onerror="this.src='https://via.placeholder.com/50';">
        <div>
          <h3>וואטסאפ של ראמי - ח.סבן</h3>
          <p class="status"><span class="status-dot"></span> מחובר</p>
        </div>
      </div>
      <div class="chat-body" id="chatBody">
        <div class="message bot-message">
          ברוך הבא לח.סבן חומרי בניין, התלמיד 6, הוד השרון! 🏗️ איך קוראים לך? 😎
          <span class="message-time"></span>
        </div>
      </div>
      <div class="chat-footer">
        <button class="attach-btn" onclick="toggleAttachMenu()">📎</button>
        <div class="attach-menu" id="attachMenu">
          <button onclick="document.getElementById('fileInput').click()">צרף מסמך 📄</button>
          <button onclick="shareLocation()">שתף מיקום 📍</button>
          <button onclick="addToCalendar()">צור אירוע 📅</button>
          <button onclick="document.getElementById('fileInput').click()">צלם תמונה 📷</button>
        </div>
        <input type="text" id="userInput" placeholder="הקלד הודעה..." onkeypress="if(event.key === 'Enter') sendMessage()">
        <button onclick="sendMessage()">➤</button>
      </div>
      <div class="file-upload">
        <input type="file" id="fileInput" accept="image/*,application/pdf" onchange="uploadFile()">
        <div class="upload-progress" id="uploadProgress"></div>
      </div>
    </div>
  </div>
  <div class="overlay" id="overlay"></div>
  <div class="order-popup" id="orderPopup">
    <h3>טופס הזמנה יוקרתי 📦</h3>
    <label>שם לקוח (על החשבונית):</label>
    <input type="text" id="orderCustomer" placeholder="למשל: יוסי כהן">
    <label>איש קשר:</label>
    <input type="text" id="orderContact" placeholder="למשל: יוסי">
    <label>נייד:</label>
    <input type="tel" id="orderPhone" placeholder="למשל: 0501234567">
    <label>סוג מנוף:</label>
    <select id="orderCrane">
      <option value="משאית מנוף">משאית מנוף</option>
      <option value="מנוף 15 מטר">מנוף 15 מטר</option>
      <option value="ללא">ללא</option>
    </select>
    <label>רחוב:</label>
    <input type="text" id="orderStreet" placeholder="למשל: התלמיד 6">
    <label>עיר:</label>
    <input type="text" id="orderCity" placeholder="למשל: הוד השרון">
    <label>פעולת מכולה:</label>
    <select id="orderContainer" onchange="showContainerCost()">
      <option value="ללא">ללא</option>
      <option value="הצבת מכולה">הצבת מכולה</option>
      <option value="החלפת מכולה">החלפת מכולה</option>
      <option value="הוצאת מכולה">הוצאת מכולה</option>
    </select>
    <span class="cost-note" id="containerCost" style="display: none;">עלות: 1416 ש"ח כולל מע"מ עד 10 ימי שכירות</span>
    <div class="items-list">
      <h4>פריטים:</h4>
      <div class="item-row">
        <input type="text" placeholder="פריט, למשל: בלוקים" class="item-name">
        <input type="number" placeholder="כמות" class="item-quantity">
        <button class="remove-item" onclick="removeItemRow(this)">×</button>
      </div>
    </div>
    <button onclick="addItemRow()">הוסף פריט +</button>
    <button onclick="submitOrder()">שלח הזמנה 🚛</button>
    <button class="close-btn" onclick="closeOrderPopup()">סגור</button>
  </div>

  <script>
    const express = require('express');
const { google } = require('googleapis');
const cors = require('cors');
require('dotenv').config();

const app = express();
app.use(cors());
app.use(express.json());

// הגדרת Google Sheets API
const sheets = google.sheets('v4');
const auth = new google.auth.GoogleAuth({
  keyFile: process.env.GOOGLE_CREDENTIALS, // קובץ JSON מהדאשבורד של Google Cloud
  scopes: ['https://www.googleapis.com/auth/spreadsheets.readonly'],
});

// נתיב לשליפת נתונים מהגיליון
app.get('/api/products', async (req, res) => {
  try {
    const authClient = await auth.getClient();
    const spreadsheetId = process.env.SPREADSHEET_ID;'13fP3cH_npVSYz-cHZWL27-cGwHldBP3VdnBdFZq4wN0' // ה-ID של הגיליון
    const range = 'Sheet1!A1:D1000'; // הטווח הרצוי

    const response = await sheets.spreadsheets.values.get({
      auth: authClient,
      spreadsheetId,
      range,
    });

    res.json(response.data.values);
  } catch (error) {
    console.error('שגיאה בשליפת מוצרים:', error);
    res.status(403).json({ error: 'אין הרשאה לגשת לגיליון' });
  }
});

// נתיב בסיסי לבדיקת פעילות השרת
app.get('/', (req, res) => {
  res.send('השרת פעיל!');
});

const PORT = process.env.PORT || 3000;
app.listen(PORT, () => {
  console.log(`השרת רץ על פורט ${PORT}`);
});


const nameData = {
  'ורד': {
    traits: 'זורחת כמו פרח, מלאת חיים ואנרגיה!',
    ramiThought: 'ורד היא כמו בלוק מושלם – יפה, חזקה, ותמיד מוסיפה צבע! 🌹',
    quip: 'ורד, עם שם כזה, את בטח שוברת לבבות במחסן! 😜'
  },
  'תמיר': {
    traits: 'מעודד, תמיד עם חיוך, מחסנאי מספר אחת!',
    ramiThought: 'תמיר הוא החבר שתמיד שם כשהמשמרת נהיית קשה! 💪',
    quip: 'תמיר, אתה מעודד את כולם, אבל מי מעודד אותך כשאשר שוב מדפיס את השבוע? 😅'
  },
  'אורן': {
    traits: 'חביב, תותח על המלגזה, קצת גמד אבל ענק בלב!',
    ramiThought: 'אורן דופק עבודה כשצריך, אבל לפעמים צריך לדחוף אותו קצת! 🚜',
    quip: 'אורן, גמדגמד, אבל כשאתה על המלגזה, אתה מלך המחסן! 😎'
  },
  'עלא': {
    traits: 'חברותי, תמיד עם סיפור טוב, מרים את המורל!',
    ramiThought: 'עלא מביא את האנרגיה, כמו משאית מלאה בלוקים! 🚚',
    quip: 'עלא, עם הסיפורים שלך, אתה צריך פודקאסט במחסן! 🎙️'
  },
  'עלי': {
    traits: 'נאמן, עובד קשה, תמיד נותן 100%!',
    ramiThought: 'עלי הוא כמו מלט – מחזיק הכל ביחד! 🧱',
    quip: 'עלי, אתה עובד כל כך קשה, אפילו המלגזה מבקשת הפסקה! 😜'
  },
  'יואב': {
    traits: 'חכם, יצירתי, תמיד עם פתרון לכל בעיה!',
    ramiThought: 'יואב הוא הראש החושב של המחסן, כמו מהנדס בלוקים! 🧠',
    quip: 'יואב, עם הראש שלך, אתה תמציא בלוק שמרכיב את עצמו! 😅'
  },
  'נתנאל': {
    traits: 'רגוע, אמין, תמיד שומר על קור רוח!',
    ramiThought: 'נתנאל הוא כמו מים ביום חם – מרגיע את כולם! 💧',
    quip: 'נתנאל, אתה כל כך רגוע, אפילו אשר לא מצליח להוציא אותך מהקצב! 😎'
  },
  'דורון': {
    traits: 'נדיב, תמיד עוזר, לב זהב!',
    ramiThought: 'דורון הוא כמו משאית שמביאה את כל הטוב למחסן! 🚛',
    quip: 'דורון, עם הלב שלך, אתה יכול למכור בלוקים בחינם ועדיין להרוויח! 😜'
  },
  'לינה': {
    traits: 'אהובת לבו של ראמי, מקסימה ומלאת קסם!',
    ramiThought: 'לינה היא הלב של המחסן, כל יום איתה הוא כמו חג! 💖',
    quip: 'לינה, ראמי אומר שאת הבלוק הכי יפה במחסן! 😍'
  },
  'שרון': {
    traits: 'צרפתיה מרעננה, תמיד עם סטייל וחיוך!',
    ramiThought: 'שרון מביאה קלאסה למחסן, כמו צבע פרימיום! 🎨',
    quip: 'שרון, עם הסטייל שלך, את יכולה למכור בלוקים בתצוגת אופנה! 😅'
  },
  'אשר': {
    traits: 'משגע את כולם עם הדפסות השבוע, אבל תמיד מצחיק!',
    ramiThought: 'אשר הוא כמו משאית שלא קוראת את המסלול, אבל בסוף מגיע! 📄',
    quip: 'אשר, תפסיק להדפיס את השבוע, ראמי כבר לא יכול לראות נייר! 😜'
  }
};

// טעינת תמונות עם גיבוי
function preloadImages() {
  const images = [
    { src: 'https://i.postimg.cc/t4Q91FDQ/Screenshot-20250427-160448-Whats-App-Business.jpg', fallback: 'https://via.placeholder.com/380x760?text=WhatsApp+Background' },
    { src: 'https://i.postimg.cc/3J9Y4b0Z/blocks.jpg', fallback: 'https://via.placeholder.com/24?text=Stylus' },
    { src: 'https://i.postimg.cc/5y3t8QzT/paint.jpg', fallback: 'https://via.placeholder.com/220?text=Paint' },
    { src: 'https://i.postimg.cc/4yqP2R9Z/tools.jpg', fallback: 'https://via.placeholder.com/220?text=Tools' }
  ];
  images.forEach(image => {
    const img = new Image();
    img.src = image.src;
    img.onerror = () => { img.src = image.fallback; };
  });
}
function getProducts() {
  return getSheetData({
    id: '1T14O3eVJzJqBXe6pr5flLckvpM4TGRycTYp5Elq2KSY',
    sheetName: 'מוצרים',
    columns: ['id', 'name', 'category', 'price', 'stock']
  });
}

// שליפת שאלות ותשובות
async function fetchResponses() {
  try {
    const sheetId = '13fP3cH_npVSYz-cHZWL27-cGwHldBP3VdnBdFZq4wN0';
    const response = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${sheetId}/values/Sheet1!A1:D1000?key=${AIzaSyCNn7GZMsQPCdRSfgz_o08M1YV63CkA3Ow}`);
    const data = await response.json();
    if (!data.values || data.values.length < 2) throw new Error('No responses found');
    responses = data.values.slice(1).map(row => ({
      question: row[0] || '',
      answer: row[1] || '',
      keywords: row[2] ? row[2].split(',').map(k => k.trim()) : [],
      synonyms: row[3] ? row[3].split(',').map(s => s.trim()) : []
    }));
    keywords = responses.map(r => ({ label: r.question, question: r.question }));
    updateKeywords();
  } catch (err) {
    console.error('Error fetching responses:', err);
    displayBotMessage('אופס, לא הצלחתי לטעון את התשובות... 😅 ודא שחיבור האינטרנט תקין ונסה שוב.');
  }
}

// שליפת מוצרים
async function fetchProducts() {
  try {
    const sheetId = '1T14O3eVJzJqBXe6pr5flLckvpM4TGRycTYp5Elq2KSY';
    const response = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${sheetId}/values/Sheet1!A1:E1000?key=${AIzaSyCNn7GZMsQPCdRSfgz_o08M1YV63CkA3Ow}`);
    const data = await response.json();
    if (!data.values || data.values.length < 2) throw new Error('No products found');
    products = data.values.slice(1).map(row => ({
      name: row[0] || '',
      category: row[1] || '',
      price: parseFloat(row[2]) || 0,
      stock: parseInt(row[3]) || 0,
      description: row[4] || ''
    }));
    updateProductSelects();
  } catch (err) {
    console.error('Error fetching products:', err);
    displayBotMessage('אופס, לא הצלחתי לטעון את המוצרים... 😅 ודא שחיבור האינטרנט תקין ונסה שוב.');
  }
}

// עדכון תיבות בחירת מוצרים
function updateProductSelects() {
  try {
    const selects = document.querySelectorAll('.item-name');
    selects.forEach(select => {
      select.innerHTML = '<option value="">בחר מוצר</option>' + products.map(product => 
        `<option value="${product.name}" data-price="${product.price}" data-stock="${product.stock}">${product.name} (${product.stock} במלאי)</option>`
      ).join('');
    });
  } catch (err) {
    console.error('Error updating product selects:', err);
  }
}

// עדכון מחיר פריט
function updateItemPrice(select) {
  try {
    const row = select.closest('.item-row');
    const priceInput = row.querySelector('.item-price');
    const selectedOption = select.options[select.selectedIndex];
    const price = selectedOption ? selectedOption.getAttribute('data-price') : '';
    priceInput.value = price ? `${price} ש"ח` : '';
  } catch (err) {
    console.error('Error updating item price:', err);
  }
}

// שמירת משתמש
async function saveUser(name, phone) {
  try {
    const response = await fetch(SCRIPT_URL, {
      method: 'POST',
      body: JSON.stringify({ action: 'saveUser', data: { name, phone } })
    });
    const result = await response.json();
    if (result.status !== 'הצלחה') throw new Error(result.message);
  } catch (err) {
    console.error('Error saving user:', err);
    displayBotMessage('אופס, לא הצלחתי לשמור את המשתמש... 😅 נסה שוב מאוחר יותר.');
  }
}

// שמירת שיחת צ'אט
async function saveChat(userName, question, answer) {
  try {
    const response = await fetch(SCRIPT_URL, {
      method: 'POST',
      body: JSON.stringify({ action: 'saveChat', data: { userName, question, answer } })
    });
    const result = await response.json();
    if (result.status !== 'הצלחה') throw new Error(result.message);
  } catch (err) {
    console.error('Error saving chat:', err);
  }
}

// עדכון סטטיסטיקות
async function updateStats(messageCount, orderCount) {
  try {
    const response = await fetch(SCRIPT_URL, {
      method: 'POST',
      body: JSON.stringify({ action: 'updateStats', data: { messageCount, orderCount } })
    });
    const result = await response.json();
    if (result.status !== 'הצלחה') throw new Error(result.message);
  } catch (err) {
    console.error('Error updating stats:', err);
  }
}

// הוספת תוכן למאגר שאלות ותשובות
async function addToResponses(question, answer, keywords = [], synonyms = []) {
  try {
    const response = await fetch(SCRIPT_URL, {
      method: 'POST',
      body: JSON.stringify({
        action: 'addResponse',
        data: { question, answer, keywords: keywords.join(','), synonyms: synonyms.join(',') }
      })
    });
    const result = await response.json();
    if (result.status !== 'הצלחה') throw new Error(result.message);
    responses.push({ question, answer, keywords, synonyms });
    keywords.push({ label: question, question });
    updateKeywords();
  } catch (err) {
    console.error('Error adding to responses:', err);
  }
}

// שליחת הודעה
async function sendMessage(inputText = null) {
  try {
    const userInput = document.getElementById('userInput');
    const message = inputText || userInput.value.trim();
    if (!message) return;

    displayUserMessage(message);
    userInput.value = '';
    moveStylus();

    if (!userName) {
      userName = message;
      await saveUser(userName, userPhone);
      displayBotMessage(`נעים להכיר, ${userName}! 😎 אני ראמי, הבוט של ח.סבן חומרי בניין!`);
      if (nameData[userName]) {
        const nameInfo = nameData[userName];
        displayBotMessage(`<span class="name-prompt">תרצה שאגלה לך מה אומר השם שלך עד שראמי יענה? 😎</span>`);
        namePrompted = true;
      } else {
        displayBotMessage('איך אפשר לעזור לך היום? 🏗️');
        updateKeywords();
      }
      return;
    }

    if (namePrompted && (message.toLowerCase().includes('כן') || message.toLowerCase().includes('בטח'))) {
      namePrompted = false;
      await handleNamePrediction(userName);
      return;
    }

    showTypingIndicator();
    const response = findResponse(message);
    setTimeout(async () => {
      hideTypingIndicator();
      displayBotMessage(response);
      await saveChat(userName, message, response);
      await updateStats(conversation.length, document.querySelectorAll('.item-row').length);
      if (nameData[userName] && Math.random() < 0.3) {
        displayBotMessage(nameData[userName].quip);
      }
    }, 1000);

  } catch (err) {
    console.error('Error sending message:', err);
    displayBotMessage('אופס, משהו השתבש... 😅 ודא שחיבור האינטרנט תקין ונסה שוב.');
  }
}

// טיפול בחיזוי שם
async function handleNamePrediction(name) {
  try {
    if (name === 'ורד') {
      const motivation = [
        'ורד, את כמו פרח שפורח בכל מצב! 🌹',
        'השם שלך מביא אור לכל מחסן, תמשיכי לזרוח!',
        'ורד, הכוח שלך הוא כמו בלוק – אי אפשר לשבור אותו!',
        'את מלאת אנרגיה, ורד, כמו משאית שדוהרת!',
        'ורד, את השראה לכל מי שפוגש אותך!',
        'החיוך שלך, ורד, שווה יותר מכל הבלוקים במחסן!',
        'ורד, את כמו צבע פרימיום – תמיד מוסיפה סטייל!',
        'השם שלך הוא סמל לחוזק ויופי, תמשיכי כך!',
        'ורד, את תמיד מצליחה להפוך יום קשה לזריחה!',
        'את כמו מלט, ורד – מחברת את כולם!',
        'ורד, יש לך את הכוח לשנות כל סיטואציה!',
        'הלב שלך, ורד, גדול כמו משאית של ח.סבן!',
        'ורד, את תמיד מביאה את האנרגיה הכי טובה!',
        'השם שלך הוא כמו שמש שמאירה את המחסן!',
        'ורד, את כמו כלי עבודה איכותי – תמיד עושה את העבודה!',
        'את מלאת חיים, ורד, כמו גינה פורחת!',
        'ורד, את תמיד יודעת איך להרים את המורל!',
        'הכוח שלך, ורד, הוא כמו מנוף 50 טון!',
        'ורד, את כמו בלוק מושלם – חזקה ויפה!',
        'השם שלך, ורד, הוא סמל להצלחה בכל משימה!'
      ];
      const encouragement = [
        'ורד, בעבודה את תמיד תזרחי כמו כוכב! 🌟',
        'הילדים שלך בטח גאים בך, ורד, את אמא מדהימה!',
        'ורד, תמשיכי לנהל את הכל כמו בוסית במחסן!',
        'את תמיד תמצאי דרך, ורד, גם ביום הכי עמוס!',
        'ורד, הילדים שלך ילמדו ממך איך להיות חזקים!',
        'בעבודה, ורד, את כמו מלגזה – תמיד דוחפת קדימה!',
        'ורד, את מנהלת את הבית כמו שראמי מנהל את המחסן!',
        'תמשיכי להיות מדהימה, ורד, בעבודה ובבית!',
        'ורד, את כמו צבע שמחזיק שנים – תמיד מושלמת!',
        'הילדים שלך, ורד, בטח יודעים שיש להם אמא תותחית!'
      ];
      const prediction = `ורד, השם שלך זורח כמו פרח! 🌹 תרצי לדעת מה צפוי לך? וואו, יש כל כך הרבה להרחיב! אני חוזה שתמשיכי להפיץ אור בכל מקום, וראמי בטוח יסכים! 😎`;
      displayBotMessage(prediction);
      for (const msg of [...motivation, ...encouragement]) {
        await addToResponses(`מוטיבציה לורד`, msg, ['ורד', 'מוטיבציה'], ['חיזוי', 'עידוד']);
      }
    } else if (nameData[name]) {
      const { traits, ramiThought, quip } = nameData[name];
      displayBotMessage(`וואו, ${name}! השם שלך אומר: ${traits} 😎 ראמי חושב: "${ramiThought}"`);
      displayBotMessage(quip);
      await addToResponses(`חיזוי ל-${name}`, `${traits} | ${ramiThought} | ${quip}`, [name, 'חיזוי'], ['שם', 'ראמי']);
    } else {
      displayBotMessage(`השם ${name} ממש מגניב! 😎 אני חוזה שתהיה כוכב במחסן, וראמי בטח מסכים!`);
      await addToResponses(`חיזוי ל-${name}`, `כוכב במחסן!`, [name, 'חיזוי'], ['שם', 'ראמי']);
    }
  } catch (err) {
    console.error('Error handling name prediction:', err);
    displayBotMessage('אופס, החיזוי התבלבל קצת... 😅 נסה שוב!');
  }
}

// מציאת תשובה
function findResponse(message) {
  try {
    const messageLower = message.toLowerCase();
    for (const response of responses) {
      const keywords = response.keywords.map(k => k.toLowerCase());
      const synonyms = response.synonyms.map(s => s.toLowerCase());
      if (keywords.some(k => messageLower.includes(k)) || 
          synonyms.some(s => messageLower.includes(s)) ||
          messageLower.includes(response.question.toLowerCase())) {
        return response.answer;
      }
    }
    return 'לא הבנתי את השאלה... 🤔 נסה מילות מפתח כמו "בלוקים", "צבעים", או "הזמנה"!';
  } catch (err) {
    console.error('Error finding response:', err);
    return 'אופס, משהו השתבש... 😅 נסה שוב!';
  }
}

// הצגת הודעת משתמש
function displayUserMessage(message) {
  try {
    const chatBody = document.getElementById('chatBody');
    if (!chatBody) throw new Error('Chat body not found');
    const messageDiv = document.createElement('div');
    messageDiv.className = 'message user-message';
    messageDiv.innerHTML = `${message}<span class="message-time">${getCurrentTime()}</span>`;
    chatBody.appendChild(messageDiv);
    chatBody.scrollTop = chatBody.scrollHeight;
    conversation.push({ type: 'user', text: message });
  } catch (err) {
    console.error('Error displaying user message:', err);
  }
}

// הצגת הודעת בוט
function displayBotMessage(message) {
  try {
    const chatBody = document.getElementById('chatBody');
    if (!chatBody) throw new Error('Chat body not found');
    const messageDiv = document.createElement('div');
    messageDiv.className = `message bot-message ${message.includes('תרצה שאגלה') ? 'name-prompt' : ''}`;
    messageDiv.innerHTML = `${message}<span class="message-time">${getCurrentTime()}</span>`;
    chatBody.appendChild(messageDiv);
    chatBody.scrollTop = chatBody.scrollHeight;
    conversation.push({ type: 'bot', text: message });
  } catch (err) {
    console.error('Error displaying bot message:', err);
  }
}

// הצגת מחוון הקלדה
function showTypingIndicator() {
  try {
    const chatBody = document.getElementById('chatBody');
    if (!chatBody) throw new Error('Chat body not found');
    const typingDiv = document.createElement('div');
    typingDiv.className = 'typing';
    typingDiv.innerHTML = '<span></span><span></span><span></span>';
    chatBody.appendChild(typingDiv);
    chatBody.scrollTop = chatBody.scrollHeight;
  } catch (err) {
    console.error('Error showing typing indicator:', err);
  }
}

// הסתרת מחוון הקלדה
function hideTypingIndicator() {
  try {
    const typingDiv = document.querySelector('.typing');
    if (typingDiv) typingDiv.remove();
  } catch (err) {
    console.error('Error hiding typing indicator:', err);
  }
}

// זמן נוכחי
function getCurrentTime() {
  return new Date().toLocaleTimeString('he-IL', { hour: '2-digit', minute: '2-digit' });
}

// עדכון כפתורי מילות מפתח
function updateKeywords() {
  try {
    const keywordsContainer = document.getElementById('keywordsContainer');
    if (!keywordsContainer) throw new Error('Keywords container not found');
    keywordsContainer.innerHTML = '';
    const currentKeywords = userName ? keywords : [{ label: 'התחל שיחה', question: 'היי' }];
    currentKeywords.forEach((keyword, index) => {
      const btn = document.createElement('button');
      btn.className = 'keyword-btn';
      btn.style.transform = `rotate(${index * (360 / currentKeywords.length)}deg) translateX(200px) rotate(-${index * (360 / currentKeywords.length)}deg)`;
      btn.style.animationDelay = `${index * 0.2}s`;
      btn.textContent = keyword.label;
      btn.onclick = () => {
        sendMessage(keyword.question);
        btn.style.animation = 'throwEffect 0.5s ease forwards';
        setTimeout(() => updateKeywords(), 500);
        displayBotMessage('וואו, הכפתור זרח כמו הבלוקים של ראמי! ✨');
      };
      keywordsContainer.appendChild(btn);
    });
  } catch (err) {
    console.error('Error updating keywords:', err);
  }
}

// החלפת מסך מלא
function toggleFullscreen() {
  try {
    const phoneFrame = document.getElementById('phoneFrame');
    phoneFrame.classList.toggle('fullscreen');
    document.querySelector('.fullscreen-btn').textContent = phoneFrame.classList.contains('fullscreen') ? '🔳' : '🔲';
  } catch (err) {
    console.error('Error toggling fullscreen:', err);
  }
}

// תפריט קבצים מצורפים
function toggleAttachMenu() {
  try {
    const menu = document.getElementById('attachMenu');
    menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
  } catch (err) {
    console.error('Error toggling attach menu:', err);
  }
}

// הצגת מקלדת וירטואלית
function showKeyboard() {
  try {
    const keyboard = document.getElementById('virtualKeyboard');
    keyboard.style.display = 'flex';
  } catch (err) {
    console.error('Error showing keyboard:', err);
  }
}

// סגירת מקלדת וירטואלית
function closeKeyboard() {
  try {
    const keyboard = document.getElementById('virtualKeyboard');
    keyboard.style.display = 'none';
  } catch (err) {
    console.error('Error closing keyboard:', err);
  }
}

// הקלדת תו
function typeKey(char) {
  try {
    const userInput = document.getElementById('userInput');
    userInput.value += char;
    moveStylus();
  } catch (err) {
    console.error('Error typing key:', err);
  }
}

// תנועת עט
function moveStylus() {
  try {
    const stylus = document.getElementById('stylus');
    const userInput = document.getElementById('userInput');
    if (userInput.value.trim()) {
      stylus.classList.add('typing');
    } else {
      stylus.classList.remove('typing');
    }
  } catch (err) {
    console.error('Error moving stylus:', err);
  }
}

// העלאת קובץ
function uploadFile() {
  try {
    const fileInput = document.getElementById('fileInput');
    const file = fileInput.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = () => {
      displayBotMessage(`קובץ "${file.name}" נשלח! 📄`);
    };
    reader.readAsDataURL(file);
  } catch (err) {
    console.error('Error uploading file:', err);
    displayBotMessage('אופס, לא הצלחתי לעלות את הקובץ... 😅');
  }
}

// שיתוף מיקום
function shareLocation() {
  try {
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(position => {
        const { latitude, longitude } = position.coords;
        displayBotMessage(`מיקום משותף: ${latitude}, ${longitude} 📍`);
      }, () => {
        displayBotMessage('לא הצלחתי לקבל את המיקום... 😔 ודא שהרשאות המיקום מופעלות.');
      });
    } else {
      displayBotMessage('שיתוף מיקום לא נתמך בדפדפן זה... 😔');
    }
  } catch (err) {
    console.error('Error sharing location:', err);
  }
}

// יצירת אירוע בלוח שנה
function addToCalendar() {
  try {
    displayBotMessage('אירוע נוסף ללוח השנה שלך! 📅');
  } catch (err) {
    console.error('Error adding to calendar:', err);
  }
}

// פתיחת טופס הזמנה
function openOrderPopup() {
  try {
    document.getElementById('orderPopup').style.display = 'block';
    document.getElementById('overlay').style.display = 'block';
  } catch (err) {
    console.error('Error opening order popup:', err);
  }
}

// סגירת טופס הזמנה
function closeOrderPopup() {
  try {
    document.getElementById('orderPopup').style.display = 'none';
    document.getElementById('overlay').style.display = 'none';
  } catch (err) {
    console.error('Error closing order popup:', err);
  }
}

// הוספת שורת פריט
function addItemRow() {
  try {
    const tableBody = document.getElementById('itemsTableBody');
    const row = document.createElement('tr');
    row.className = 'item-row';
    row.innerHTML = `
      <td><select class="item-name" onchange="updateItemPrice(this)"></select></td>
      <td><input type="number" class="item-quantity" min="1" placeholder="כמות"></td>
      <td><input type="text" class="item-price" readonly></td>
      <td><button class="remove-item" onclick="removeItemRow(this)">×</button></td>
    `;
    tableBody.appendChild(row);
    updateProductSelects();
  } catch (err) {
    console.error('Error adding item row:', err);
  }
}

// הסרת שורת פריט
function removeItemRow(button) {
  try {
    button.closest('.item-row').remove();
  } catch (err) {
    console.error('Error removing item row:', err);
  }
}

// שליחת הזמנה
async function submitOrder() {
  try {
    const customer = document.getElementById('orderCustomer').value;
    const contact = document.getElementById('orderContact').value;
    const phone = document.getElementById('orderPhone').value;
    const crane = document.getElementById('orderCrane').value;
    const street = document.getElementById('orderStreet').value;
    const city = document.getElementById('orderCity').value;
    const container = document.getElementById('orderContainer').value;

    const items = Array.from(document.querySelectorAll('.item-row')).map(row => ({
      name: row.querySelector('.item-name').value,
      quantity: parseInt(row.querySelector('.item-quantity').value) || 1
    }));

    if (!customer || !contact || !phone || !items.every(item => item.name && item.quantity)) {
      displayBotMessage('אנא מלא את כל השדות בטופס ההזמנה! 📋');
      return;
    }

    const response = await fetch(SCRIPT_URL, {
      method: 'POST',
      body: JSON.stringify({ action: 'saveOrder', data: { customer, contact, phone, crane, street, city, container, items } })
    });
    const result = await response.json();
    if (result.status !== 'הצלחה') throw new Error(result.message);

    displayBotMessage(`ההזמנה נשלחה בהצלחה, ${customer}! 🚛 תודה שקנית אצל ראמי!`);
    closeOrderPopup();
    await updateStats(conversation.length, document.querySelectorAll('.item-row').length);
  } catch (err) {
    console.error('Error submitting order:', err);
    displayBotMessage('אופס, לא הצלחתי לשלוח את ההזמנה... 😅 ודא שחיבור האינטרנט תקין ונסה שוב.');
  }
}

// הצגת עלות מכולה
function showContainerCost() {
  try {
    const container = document.getElementById('orderContainer').value;
    const costNote = document.getElementById('containerCost');
    costNote.style.display = container !== 'ללא' ? 'block' : 'none';
  } catch (err) {
    console.error('Error showing container cost:', err);
  }
}

// פתיחת חלונית "איך אני עובד"
function openHowToPopup() {
  try {
    document.getElementById('howToPopup').style.display = 'block';
    document.getElementById('overlay').style.display = 'block';
  } catch (err) {
    console.error('Error opening how-to popup:', err);
  }
}

// סגירת חלונית "איך אני עובד"
function closeHowToPopup() {
  try {
    document.getElementById('howToPopup').style.display = 'none';
    document.getElementById('overlay').style.display = 'none';
  } catch (err) {
    console.error('Error closing how-to popup:', err);
  }
}

// טעינת הדף
window.onload = () => {
  try {
    preloadImages();
    fetchResponses();
    fetchProducts();
    updateKeywords();
    displayBotMessage('<span class="welcome-message">ברוך הבא לח.סבן חומרי בניין, התלמיד 6, הוד השרון! 🏗️ איך קוראים לך? 😎</span>');
    setTimeout(() => {
      const input = document.getElementById('userInput');
      if (input) {
        input.classList.add('guide');
        setTimeout(() => input.classList.remove('guide'), 6000);
      }
    }, 2000);
  } catch (err) {
    console.error('Error on load:', err);
    displayBotMessage('אופס, משהו השתבש בטעינת הדף... 😅 ודא שחיבור האינטרנט תקין ונסה שוב.');
  }
};

    let userName = '';
    let userPhone = '';
    let conversation = [];

    // מאגר תוכן מובנה - החזרת הדו-שיח המלא
    const responses = [
      { question: 'מה שעות הפתיחה?', answer: 'פתוחים מ-06:00 עד 18:00, ראשון-חמישי, שישי עד 13:00, התלמיד 6, הוד השרון. תגיע ותראה איך ראמי שולט! ☕', keywords: ['שעות', 'פתיחה', 'זמנים'], synonyms: ['פעילות', 'עבודה', 'מתי'] },
      { question: 'יש לכם בלוקים?', answer: 'בלוקים? טונות של איכות! 🧱 תגיד כמה, ואבדוק מחיר עם ראמי. <img src="https://i.postimg.cc/3J9Y4b0Z/blocks.jpg" class="message-image" onerror="this.src=\'https://via.placeholder.com/250\';"> רוצה מחשבון? 📏 <a href="#" onclick="showCalculator(\'blocks\')">חשב עכשיו</a>', keywords: ['בלוקים', 'לבנים', 'אבנים'], synonyms: ['חומרי בנייה', 'קירות'] },
      { question: 'אפשר להזמין מכולה?', answer: 'מכולה? בכיף! 🚛 הצבה, החלפה, או הוצאה? עלות הצבה/החלפה: 1416 ש"ח כולל מע"מ. <a href="#" onclick="openOrderPopup()">פתח הזמנה</a> או שאשאל אותך לטופס יוקרתי? 😎', keywords: ['מכולה', 'קונטיינר', 'משלוח'], synonyms: ['הובלה', 'פסולת'] },
      { question: 'מי זה ראמי?', answer: 'ראמי הוא האגדה של ח.סבן! 😎 מלך הבלוקים והחיוכים. שלח לו וואטסאפ? 📲', keywords: ['ראמי', 'מנהל', 'בעלים'], synonyms: ['הבוס', 'אחראי'] },
      { question: 'אפשר הנחה?', answer: 'הנחה? תביא חיוך ואראה מה אפשר לעשות! 😄 מבצע: 10% על צבעי טמבור! ראית איך הכפתור זרח? ✨', keywords: ['הנחה', 'מחיר', 'מבצע'], synonyms: ['זול', 'הטבה'] },
      { question: 'צבעים?', answer: 'צבעים של טמבור, נירלט, יעקובי! 🎨 תגיד גוון וגודל, ואשלח לראמי. <img src="https://i.postimg.cc/5y3t8QzT/paint.jpg" class="message-image" onerror="this.src=\'https://via.placeholder.com/250\';"> מחשבון צבע? <a href="#" onclick="showCalculator(\'paint\')">חשב כמות</a>', keywords: ['צבעים', 'צבע', 'גוון'], synonyms: ['לקות', 'משטחים'] },
      { question: 'כלי עבודה?', answer: 'בוש, מקיטה, שטל – הכל כאן! 🔧 מבצע: 15% על מקדחות בוש! <img src="https://i.postimg.cc/4yqP2R9Z/tools.jpg" class="message-image" onerror="this.src=\'https://via.placeholder.com/250\';">', keywords: ['כלי עבודה', 'ציוד', 'מקדחה'], synonyms: ['כלים', 'מכשירים'] },
      { question: 'חול?', answer: 'חול? יותר טונות ממדבר סהרה! 🏖️ תגיד כמה, ואכין טופס יוקרתי! 😎 <a href="#" onclick="openOrderPopup()">פתח הזמנה</a>', keywords: ['חול', 'מחיר'], synonyms: ['חומרים', 'עלות'] },
      { question: 'מיקום?', answer: 'התלמיד 6, הוד השרון, ממש ליד כביש 55! 🗺️ פתוחים מ-06:00 עד 18:00, ראשון-חמישי.', keywords: ['מיקום', 'כתובת', 'איפה'], synonyms: ['מקום', 'הגעה'] },
      { question: 'מבצעים?', answer: 'מבצעים משגעים! 10% על טמבור, 15% על מקדחות בוש! 🎉 תגיד מה בא לך!', keywords: ['מבצעים', 'הנחה', 'מבצע'], synonyms: ['הטבות', 'זול'] }
    ];

    const randomResponses = [
      'וואו, שאלה כבדה כמו משאית מלט! 🤯 תפרט קצת?',
      'לא תפסתי, אבל ראמי יודע הכל! 📲 שלח לו וואטסאפ?',
      'שאלה כמו בלוק עקשן! 😅 תנסה שוב?',
      'צריך קצת צבע על השאלה הזו! 🎨 תגיד עוד?'
    ];

    const keywords = [
      { label: 'שעות פתיחה', question: 'מה שעות הפתיחה?' },
      { label: 'בלוקים', question: 'יש לכם בלוקים?' },
      { label: 'מכולה', question: 'אפשר להזמין מכולה?' },
      { label: 'הנחה', question: 'אפשר הנחה?' },
      { label: 'מי זה ראמי?', question: 'מי זה ראמי?' },
      { label: 'צבעים', question: 'צבעים?' },
      { label: 'כלי עבודה', question: 'כלי עבודה?' },
      { label: 'חול', question: 'חול?' },
      { label: 'מיקום', question: 'מיקום?' },
      { label: 'מבצעים', question: 'מבצעים?' }
    ];

    // בדיקת טעינת תמונות
    function preloadImages() {
      const images = [
        'https://i.postimg.cc/t4Q91FDQ/Screenshot-20250427-160448-Whats-App-Business.jpg',
        'https://i.postimg.cc/3J9Y4b0Z/blocks.jpg',
        'https://i.postimg.cc/5y3t8QzT/paint.jpg',
        'https://i.postimg.cc/4yqP2R9Z/tools.jpg',
        'https://theverifier.co.il/wp-content/uploads/2019/02/whatsapp-promo-1024x538.png'
      ];
      images.forEach(src => {
        const img = new Image();
        img.src = src;
        img.onerror = () => { img.src = 'https://via.placeholder.com/250'; };
      });
    }

    // עדכון זמן הודעות
    function updateMessageTimes() {
      document.querySelectorAll('.message-time').forEach(span => {
        span.textContent = new Date().toLocaleTimeString('he-IL', { hour: '2-digit', minute: '2-digit' });
      });
    }

    window.onload = () => {
      try {
        preloadImages();
        updateKeywords();
        updateMessageTimes();
      } catch (err) {
        console.error('Error on load:', err);
      }
    };

    function toggleFullscreen() {
      try {
        const tabletFrame = document.getElementById('tabletFrame');
        tabletFrame.classList.toggle('fullscreen');
        document.querySelector('.fullscreen-btn').textContent = tabletFrame.classList.contains('fullscreen') ? '🔳' : '🔲';
      } catch (err) {
        console.error('Error toggling fullscreen:', err);
      }
    }

    function toggleAttachMenu() {
      try {
        const menu = document.getElementById('attachMenu');
        menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
      } catch (err) {
        console.error('Error toggling attach menu:', err);
      }
    }

    function updateKeywords() {
      try {
        const keywordsContainer = document.getElementById('keywordsContainer');
        keywordsContainer.innerHTML = '';
        const currentKeywords = userName ? keywords : [{ label: 'התחל שיחה', question: 'היי' }];
        currentKeywords.forEach((keyword, index) => {
          const btn = document.createElement('button');
          btn.className = 'keyword-btn';
          btn.style.transform = `rotate(${index * (360 / currentKeywords.length)}deg) translateX(400px) rotate(-${index * (360 / currentKeywords.length)}deg)`;
          btn.style.animationDelay = `${index * 0.2}s`;
          btn.textContent = keyword.label;
          btn.onclick = () => {
            sendMessage(keyword.question);
            btn.style.animation = 'throwEffect 0.5s ease forwards';
            setTimeout(() => updateKeywords(), 500);
            displayBotMessage(`וואו, הכפתור זרח כמו הבלוקים של ראמי! ✨`);
          };
          keywordsContainer.appendChild(btn);
        });
      } catch (err) {
        console.error('Error updating keywords:', err);
      }
    }

    function openOrderPopup() {
      try {
        document.getElementById('orderPopup').style.display = 'block';
        document.getElementById('overlay').style.display = 'block';
        document.getElementById('orderCustomer').value = userName || '';
        document.getElementById('orderPhone').value = userPhone || '';
      } catch (err) {
        console.error('Error opening order popup:', err);
      }
    }

    function closeOrderPopup() {
      try {
        const popup = document.getElementById('orderPopup');
        popup.style.animation = 'fadeOut 0.3s ease forwards';
        setTimeout(() => {
          popup.style.display = 'none';
          document.getElementById('overlay').style.display = 'none';
          popup.style.animation = '';
        }, 300);
      } catch (err) {
        console.error('Error closing order popup:', err);
      }
    }

    function showContainerCost() {
      try {
        const container = document.getElementById('orderContainer').value;
        const costNote = document.getElementById('containerCost');
        costNote.style.display = container === 'הצבת מכולה' || container === 'החלפת מכולה' ? 'inline' : 'none';
      } catch (err) {
        console.error('Error showing container cost:', err);
      }
    }

    function addItemRow() {
      try {
        const itemsList = document.querySelector('.items-list');
        const row = document.createElement('div');
        row.className = 'item-row';
        row.innerHTML = `
          <input type="text" placeholder="פריט, למשל: בלוקים" class="item-name">
          <input type="number" placeholder="כמות" class="item-quantity">
          <button class="remove-item" onclick="removeItemRow(this)">×</button>
        `;
        itemsList.appendChild(row);
        row.style.animation = 'slideIn 0.3s ease';
      } catch (err) {
        console.error('Error adding item row:', err);
      }
    }

    function removeItemRow(btn) {
      try {
        const row = btn.parentElement;
        row.style.animation = 'fadeOut 0.3s ease forwards';
        setTimeout(() => row.remove(), 300);
      } catch (err) {
        console.error('Error removing item row:', err);
      }
    }

    async function submitOrder() {
      try {
        const customer = document.getElementById('orderCustomer').value;
        const contact = document.getElementById('orderContact').value;
        const phone = document.getElementById('orderPhone').value;
        const crane = document.getElementById('orderCrane').value;
        const street = document.getElementById('orderStreet').value;
        const city = document.getElementById('orderCity').value;
        const container = document.getElementById('orderContainer').value;
        const items = Array.from(document.querySelectorAll('.item-row')).map(row => ({
          name: row.querySelector('.item-name').value,
          quantity: row.querySelector('.item-quantity').value
        }));

        if (!customer || !contact || !phone || !street || !city || items.length === 0 || !items[0].name || !items[0].quantity) {
          displayBotMessage('אופס, תמלא את כל השדות כדי שנריץ את ההזמנה! 😊');
          return;
        }

        const orderData = { customer, contact, phone, crane, street, city, container, items };
        closeOrderPopup();
        displayBotMessage(`הזמנה נשלחה לראמי ביוקרה! 📦 פרטים:\n${JSON.stringify(orderData, null, 2)}`);
        sendOrderToWhatsApp(orderData);
      } catch (err) {
        console.error('Error submitting order:', err);
        displayBotMessage('אופס, משהו השתבש... 😅 נסה שוב.');
      }
    }

    async function sendMessage(inputMessage) {
      try {
        const chatBody = document.getElementById('chatBody');
        const userInput = document.getElementById('userInput');
        const message = inputMessage || userInput.value.trim();
        if (!message) return;

        const userMsg = document.createElement('div');
        userMsg.className = 'message user-message';
        userMsg.innerHTML = `${message}<span class="message-time"></span>`;
        chatBody.appendChild(userMsg);
        chatBody.scrollTop = chatBody.scrollHeight;
        conversation.push({ question: message, answer: '' });
        userInput.value = '';

        const typing = document.createElement('div');
        typing.className = 'typing';
        typing.innerHTML = '<span></span><span></span><span></span>';
        chatBody.appendChild(typing);
        chatBody.scrollTop = chatBody.scrollHeight;

        await new Promise(resolve => setTimeout(resolve, 1000));

        const normalizedMessage = message.toLowerCase();
        if (!userName && normalizedMessage !== 'היי') {
          userName = message;
          displayBotMessage(`נעים מאוד, ${userName}! 😎 מה אפשר לעשות בשבילך?`);
          updateKeywords();
        } else {
          const response = responses.find(r =>
            r.keywords.some(k => normalizedMessage.includes(k.toLowerCase())) ||
            r.synonyms.some(s => normalizedMessage.includes(s.toLowerCase()))
          );

          if (response) {
            displayBotMessage(response.answer);
            conversation[conversation.length - 1].answer = response.answer;
          } else {
            const randomResponse = randomResponses[Math.floor(Math.random() * randomResponses.length)];
            displayBotMessage(randomResponse);
            conversation[conversation.length - 1].answer = randomResponse;
          }
        }

        chatBody.removeChild(typing);
        updateMessageTimes();
      } catch (err) {
        console.error('Error sending message:', err);
        displayBotMessage('אופס, משהו השתבש... 😅 נסה שוב.');
      }
    }

    async function uploadFile() {
      try {
        const fileInput = document.getElementById('fileInput');
        const file = fileInput.files[0];
        if (!file) {
          displayBotMessage('לא בחרת קובץ! 📂 נסה שוב.');
          return;
        }

        const progress = document.getElementById('uploadProgress');
        progress.style.display = 'block';

        await new Promise(resolve => setTimeout(resolve, 2000));
        displayBotMessage(`קובץ ${file.name} הועלה בסטייל! 📎 נשלח לראמי.`);
        sendFileToWhatsApp(file.name);

        progress.style.display = 'none';
        fileInput.value = '';
      } catch (err) {
        console.error('Error uploading file:', err);
        displayBotMessage('אופס, ההעלאה לא הצליחה... 😕 נסה שוב.');
      }
    }

    function shareLocation() {
      try {
        displayBotMessage('מיקום נשלח! 📍 מעביר לראמי ביוקרה.');
        sendToWhatsApp('מיקום: התלמיד 6, הוד השרון');
      } catch (err) {
        console.error('Error sharing location:', err);
      }
    }

    function addToCalendar() {
      try {
        displayBotMessage('תזכורת נוספה ליומן! 📅 תגיע לתלמיד 6 בסטייל!');
      } catch (err) {
        console.error('Error adding to calendar:', err);
      }
    }

    function showCalculator(type) {
      try {
        displayBotMessage(`מחשבון ${type === 'blocks' ? 'בלוקים' : 'צבע'} יוקרתי ייפתח בקרוב! 📏 פונקציה בבנייה.`);
      } catch (err) {
        console.error('Error showing calculator:', err);
      }
    }

    function sendToWhatsApp(message) {
      try {
        const msg = encodeURIComponent(message);
        const url = `https://wa.me/972508860896?text=${msg}`;
        window.open(url, '_blank');
      } catch (err) {
        console.error('Error sending to WhatsApp:', err);
      }
    }

    function sendOrderToWhatsApp(order) {
      try {
        const message = `📦 הזמנה יוקרתית!\nשם: ${order.customer}\nאיש קשר: ${order.contact}\nנייד: ${order.phone}\nכתובת: ${order.street}, ${order.city}\nמנוף: ${order.crane}\nמכולה: ${order.container}${order.container.includes('הצבה') || order.container.includes('החלפה') ? ' (1416 ש"ח)' : ''}\nפריטים:\n${order.items.map((item, i) => `${i + 1}. ${item.name} - ${item.quantity} יחידות`).join('\n')}`;
        sendToWhatsApp(message);
      } catch (err) {
        console.error('Error sending order to WhatsApp:', err);
      }
    }

    function sendFileToWhatsApp(fileName) {
      try {
        const message = `📎 קובץ יוקרתי!\nשם: ${userName}\nקובץ: ${fileName}`;
        sendToWhatsApp(message);
      } catch (err) {
        console.error('Error sending file to WhatsApp:', err);
      }
    }

    function displayBotMessage(message) {
      try {
        const chatBody = document.getElementById('chatBody');
        const botMsg = document.createElement('div');
        botMsg.className = 'message bot-message';
        botMsg.innerHTML = `${message}<span class="message-time"></span>`;
        chatBody.appendChild(botMsg);
        chatBody.scrollTop = chatBody.scrollHeight;
        updateMessageTimes();
      } catch (err) {
        console.error('Error displaying bot message:', err);
      }
    }
  </script>
</body>
</html>
